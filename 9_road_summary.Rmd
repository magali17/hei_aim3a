---
title: "Epi Results using Onroad Exposure Models"
author: "Magali Blanco"
date: ' `r Sys.time()` '
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
    number_sections: true
    toc_float: true
    collapsed: false
    smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

# Setup 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      cache=F, cache.comments = F, 
                      message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE#, fig.height = 10, fig.width = 10
                      )  

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
           detach, character.only=TRUE, unload=TRUE, force=TRUE))}

pacman::p_load(tidyverse, kableExtra)    

dt_path <- file.path("Output", readRDS(file.path("Output", "latest_dt_version.rda")))

set.seed(1)

source("functions.R")
output_data_path <- file.path(dt_path, "epi")

image_path <- file.path("..", "Manuscript", "Images", "v4")
if(!dir.exists(file.path(image_path, "other", "road"))) {dir.create(file.path(image_path, "other", "ml"), recursive = T)}
# ggplot settings
theme_set(theme_bw())
theme_update(legend.position = "bottom")

##################################################################################################
# LOAD DATA
##################################################################################################
#model eval
model_eval <- readRDS(file.path(dt_path, "model_eval.rda"))

cw <- read.csv(file.path(dt_path, "onroad_model_cw.csv")) %>%
  mutate(variable="pnc_noscreen") %>%
  label_pollutants() 

# person-level exposures 
cs <- readRDS(file.path(output_data_path, "dt_for_cross_sectional_analysis_road.rda")) %>%
  rename(exposure = avg_0_5_yr) %>%  
  select(-starts_with("avg_")) 
  
# health effect estimates & CW
model_coefs <- readRDS(file.path(output_data_path, "model_coefs_road.rda")) %>%
  mutate(variable="pnc_noscreen") %>%
  label_pollutants()

```

# Model definitions

```{r}
cw %>%
  distinct(spatial_code, design, version, visits, adjusted) %>% 
  rename(spatial = spatial_code) %>%
  mutate(spatial= ifelse(spatial=="sn", "Non-Spatial", "Spatial")) %>%
  mutate_all(~str_to_title(.)) %>%
  rename_all(~str_to_title(.)) %>%
  kable() %>% 
  kable_styling()

```

# Model R2
This should be in Si's 2023 paper (SI?) along with model descriptiosn? 

# Participant Exposrue Predictions 

comparison of predicted 5 yr exposures at baseline

```{r}
# plot
cs_ml %>%
  pivot_wider(names_from = model, values_from = exposure) %>%  
  pivot_longer(cols = RF:TR) %>%
  
  ggplot(aes(x=get('UK-PLS'), y=value, col=name)) +
  geom_point(alpha=0.05) +
  geom_smooth() +
  geom_abline(slope = 1, intercept = 0, linetype=2) + 
  labs(col="Machine Learning\nModel", y="Machine Learning Prediction", x= "UK-PLS Prediction")

#table
cs_ml %>%
  group_by(model) %>%
  alt_boxplot(var="exposure") %>%
  rename(Q2.5=Qmin, Q97.5=Qmax) %>%
  kable(caption = "Distribution of UFP (pt/cm3) predictions", 
        digits = 0, format.args = list(big.mark=",")) %>% 
  kable_styling()

```

**Correlations**: exposure predictions from all models generate highly correlated predictions

```{r}

cs_ml %>%
  pivot_wider(names_from = model, values_from = exposure) %>%
  rename(ukpls = 'UK-PLS') %>%
  pivot_longer(cols = RF:TR) %>%
  group_by(name) %>%
  summarize(correlation = cor(ukpls, value)) %>%
  kable(caption = "Correlation (R) of UK-PLS predictions with predictions from machine learning methods", 
        digits = 2,
        col.names = c("ML Exposure Model", "Correlation with UK-PLS")
          ) %>%
  kable_styling()

```

# Comparison of health effect estimates (CASI-IRT)

the resulting health estimates from using UK-PLS and various ML UFP exposure models is similar, with random forests & spatcv being the most different (~25-35% lower point estimate)

# --> could color my R2

```{r}
ref_beta <- model_coefs_ml$est[model_coefs_ml$model=="UK-PLS"]

print("adjustd association between P-TRAK UFP (1k pt/cm3) and CASI-IRT")
model_coefs_ml %>%
  ggplot(aes(x=model)) +  
  geom_hline(yintercept = ref_beta, linetype=1, alpha=0.5) +
  geom_hline(yintercept = 0, linetype=2, alpha=0.2) +
  geom_pointrange(aes(y=est, ymin=lower, ymax=upper), size=0.5, alpha=0.8) +
  
  scale_y_continuous(sec.axis = sec_axis(
    trans=~(.-ref_beta)/-ref_beta, name="% Difference from UK-PLS", labels = scales::percent)) +
  labs(col = "Statistically Significant",
           x="Machine Learning Model",
           y = "Coefficient Estimate (95% CI)"
           )

```



