---
title: "Epi Results using Onroad Exposure Models"
author: "Magali Blanco"
date: ' `r Sys.time()` '
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
    number_sections: true
    toc_float: true
    collapsed: false
    smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

# Setup 

```{r setup, include=FALSE}
# Rscript -e 'rmarkdown::render("9_road_summary.Rmd", "html_document")'
knitr::opts_chunk$set(echo = F, 
                      cache=F, cache.comments = F, 
                      message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE)  

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
           detach, character.only=TRUE, unload=TRUE, force=TRUE))}

pacman::p_load(tidyverse, kableExtra, ggpubr, sf, ggspatial,# ggpubr::ggarange()
               #ggmap
               osmdata, 
               rosm, ## For OpenStreetMap tiles (background)
               ggspatial, # annotation_spatial
               tigris,
               ggmap
               )    

dt_path <- file.path("Output", readRDS(file.path("Output", "latest_dt_version.rda")))

set.seed(1)

source("functions.R")
output_data_path <- file.path(dt_path, "epi", "20240725")

image_path <- file.path("..", "Manuscript", "Images", "v5", "other", "road")
if(!dir.exists(image_path)) {dir.create(image_path, recursive = T)}
if(!dir.exists(file.path(image_path, "SI"))) {dir.create(file.path(image_path, "SI"), recursive = T)}
if(!dir.exists(file.path(image_path, "presentations"))) {dir.create(file.path(image_path, "presentations"), recursive = T)}
# ggplot settings
theme_set(theme_bw())
theme_update(legend.position = "bottom")
 
##################################################################################################
# FUNCTIONS
##################################################################################################
# fn to recode onroad data
design_levels <- c("All", "Balanced", "Random Segments", "Random Clusters", "Sensible Clusters", "Unsensible Clusters", "Road Type", "Route")  %>% rev()

recode_onroad_dt <- function(dt) {
  dt %>%
    mutate(
      #spatial = ifelse(spatial_code=="sn", "Non-spatially Dependent Sampling", "Spatially Unbalanced Sampling"),
      # spatial = ifelse(design %in% c("road_type", "sensible", "unsensible") | , 
      #                  
      #                  "Non-spatially Dependent Sampling", "Spatially Unbalanced Sampling"),
      
      
      visits = str_extract(visits, "\\d+"),
      version = ifelse(adjusted=="adjusted", paste(version, "plume adj"), version),
      version = gsub("hours", "hr", version),
      version = gsub("business", "bus", version),
      version = str_to_title(version),
      #version = factor(version, levels = version_levels),
      version = factor(version, levels = sort(unique(version))),
      design = case_when(
        design=="balanced" ~ "balanced",
        design=="unbalanced" ~ "random segments",
        design=="random" ~ "random clusters",
        design=="sensible" ~ "sensible clusters",
        design=="unsensible" ~ "unsensible clusters",
        design=="road_type" ~ "road type",
        design=="route" ~ "route",
         ),
      design = str_to_title(design),
      design = factor(design, levels = design_levels),
      adjusted = str_to_title(adjusted)
      ) 
  
}
##################################################################################################
summary_table <- function(df, var){
  df <- df %>%
    rename(var = all_of(var)) %>%
    
    #calculate quantiles
    summarize(
      N = n(),
      Min = min(var),
      Q05 = quantile(var, 0.05),
      Q10 = quantile(var, 0.10),
      Q25 = quantile(var, 0.25),
      Q50 = quantile(var, 0.50),
      Q75 = quantile(var, 0.75),
      Q90 = quantile(var, 0.90),
      Q95 = quantile(var, 0.95),
      Max = max(var)
    ) %>%
    ungroup()
  
  names(df)[names(df)==var] <- var
  
  return(df) 
  
}

##################################################################################################
# fn filters out sensitivity analyses & adds labels to prep for figures/tables
prep_for_figs <- function(dt, 
                      designs_to_keep = main_designs,
                      versions_to_keep = main_versions,
                      visits_to_keep=main_visits,
                      cluster_to_keep = main_cluster
                      ) {
  
  dt %>%
    filter(design %in% designs_to_keep,
           version %in% versions_to_keep,
           visits %in% visits_to_keep,
           cluster_type %in% c(cluster_to_keep, NA)
           ) %>%
    rename(plume_adjustment=adjusted) %>%
    mutate(visits = paste(visits, "visits"),
           visits = factor(visits, levels=paste(c(1:99), "visits")),
           design = factor(design, levels = design_levels),
           temporal_adjustment = case_when(
             grepl(" Temp Adj 1", version) ~ "Fixed Site Temporal Adjustment",
             grepl(" Temp Adj 2", version) ~ "Underwrite Temporal Adjustment",
            .default = "No Temporal Adjustment"),
           temporal_adjustment = factor(temporal_adjustment, levels=c("Underwrite Temporal Adjustment","Fixed Site Temporal Adjustment", "No Temporal Adjustment")),
           version = gsub(" Plume Adj| Temp Adj \\d", "", version),
           plume_adjustment = case_when(
             plume_adjustment=="Adjusted" ~ "Plume Adjusted",
             plume_adjustment=="Unadjusted" ~ "Not Plume Adjusted",
             .default = plume_adjustment),
           plume_adjustment = factor(plume_adjustment, c("Plume Adjusted", "Not Plume Adjusted"))
           ) 
}

##################################################################################################
# LOAD DATA
##################################################################################################
# raw mobile data
#cov <- readRDS(file.path("data", "onroad", "annie", "cov_onroad_preprocessed.rds")) #%>% pull(native_id)
project_crs <- 4326  #lat/long
m_crs <- 32148

clusters <- readRDS(file.path("data", "onroad", "annie", "segment_clusters_updated.rds")) %>%
  select(-c(latitude, longitude)) %>%
  # drop annie's old clusters for now
  filter(cluster_type != "cluster3")

cov <- readRDS(file.path("data", "onroad", "dr0364d_20230331_modified.rda")) %>%
  st_as_sf(coords = c('longitude', 'latitude'), crs=project_crs, remove = F) %>%
  st_transform(m_crs)  
  
onroad_cov <- cov %>%
  # add cluster IDs
  left_join(clusters, by = c("location" = "id")) %>%
  select(location, cluster_type, #cluster, 
         everything())

saveRDS(onroad_cov, file.path("data", "onroad", "dr0364d_20230331_modified_with_clusters.rda"))

# crosswalks
cw <- read.csv(file.path(dt_path, "onroad", "onroad_model_cw.csv")) %>%
  # drop annie's old clusters for now
  filter(!grepl("_c3_", model)) %>%
  mutate(variable="pnc_noscreen") %>%
  recode_onroad_dt() %>%
  label_pollutants() 

stationary_cw <- read.csv(file.path(dt_path, "model_cw.csv")) %>%
  filter(variable =="pnc_noscreen",
         design == "full") %>% 
  label_pollutants()  %>%
  mutate(visits = "29",
         adjusted = "Unadjusted",
         #spatial = "Reference"
         )

cw2 <- bind_rows(cw, stationary_cw) %>%
  select(model, campaign, version, design, visits, adjusted, #spatial
         )

#model eval
eval_files <- list.files(file.path(dt_path, "onroad", "model_eval")) %>% str_subset(".rda")

model_eval <- lapply(eval_files, function(x){
  readRDS(file.path(dt_path, "onroad", "model_eval", x)) %>%
    # drop annie's old clusters for now
    filter(!grepl("_c3_", model)) %>%
    left_join(select(cw, #spatial, 
                    cluster_type, design, version, visits, adjusted, campaign, model), by="model") 
  }) %>%
  bind_rows()
  
stationary_model_eval <- readRDS(file.path(dt_path, "model_eval.rda")) %>%
  filter(reference == "gs_estimate",
         model %in% stationary_cw$model)  

#ref health estimates from stationary models & extended health analyses
ref_model_coefs <- readRDS(file.path(output_data_path, "model_coefs_extended.rda" #"model_coefs.rda"
                                     )) %>%
  filter(model=="s_pncnoscreen_all_01") %>%
  left_join(select(stationary_model_eval, model, reg_based_R2, MSE_based_R2), by="model")
 
tot_pnc <- filter(ref_model_coefs, model=="s_pncnoscreen_all_01") %>% pull(est)

## save as above for reduced health models
ref_model_coefs_reduced <- readRDS(file.path(output_data_path, "model_coefs.rda")) %>%
  filter(model=="s_pncnoscreen_all_01") %>%
  left_join(select(stationary_model_eval, model, reg_based_R2, MSE_based_R2), by="model")
 
tot_pnc_reduced <- filter(ref_model_coefs_reduced, model=="s_pncnoscreen_all_01") %>% pull(est)






# person-level exposures 
stationary_cs <- readRDS(file.path(output_data_path, "dt_for_cross_sectional_analysis.rda")) %>%
  rename(exposure = avg_0_5_yr) %>%  
  select(-starts_with("avg_")) %>%
  right_join(stationary_cw, by="model")

cs <- readRDS(file.path(output_data_path, "dt_for_cross_sectional_analysis_road.rda")) %>%
  rename(exposure = avg_0_5_yr) %>%  
  select(-starts_with("avg_")) %>%
  right_join(cw, by="model") %>%
  bind_rows(stationary_cs)

# health effect estimates & CW
model_coefs <- readRDS(file.path(output_data_path, "model_coefs_road_extended.rda")) %>%
  right_join(cw, by="model") %>%
  #filter(model %in% cw$model) %>%
  mutate(variable="pnc_noscreen")  

## alt - reduced adjustment models
# health effect estimates & CW
model_coefs_reduced_model <- readRDS(file.path(output_data_path, "models_r_all.rda")) %>%
  filter(term=="avg_0_5_yr") %>%
  #rename(exposure = avg_0_5_yr) %>%  
  right_join(cw, by="model") %>%
  mutate(variable="pnc_noscreen")  


# onroad model predictions at stationary locations
stationary_prediction_files <- list.files(file.path(dt_path, "onroad", "model_eval", "predictions_at_stationary_sites"))

# x=stationary_prediction_files[1]
onroad_predictions <- lapply(stationary_prediction_files, function(x){
  readRDS(file.path(dt_path, "onroad", "model_eval", "predictions_at_stationary_sites", x))
  }) %>%
  bind_rows() %>% 
  right_join(cw, by="model")

all_predictions <- readRDS(file.path(dt_path, "UK Predictions", "all_predictions.rda")) %>%
  filter(design == "full",
         variable == "pnc_noscreen") %>%
  mutate(model = "s_pncnoscreen_all_01",
         visits = "29", #as.character(visits)
         version = "All Hr") %>%
  left_join(select(stationary_cw, variable, design, model))  

all_predictions <- bind_rows(onroad_predictions, all_predictions)  

ref_prediction_distribution <- all_predictions %>%
  filter(model == ref_model_coefs$model) %>%
  summarize(n=n(),
            median = median(prediction),
            q25 = quantile(prediction, 0.25),
            q75 = quantile(prediction, 0.75)) 

# reference P-TRAK data - number of visits (stops) per site; for the HEI dataset (not necessarily the "true" health models)
stops_w <- readRDS(file.path(dt_path, "stops_used.rda"))

# GIS
monitoring_area <- readRDS(file.path("data", "GIS", "monitoring_area_shp.rda"))

##################################################################################################
# COMMON VARIABLES
##################################################################################################
main_designs <- str_subset(design_levels, "Sensible|Unsensible|Road Type", negate = T)


#version_levels <- unique(cw$version)
version_levels <- c("All Hr Plume Adj", "All Hr", 
                  
                    "Bus Hr Temp Adj 2 Plume Adj", "Bus Hr Temp Adj 2",
                    "Bus Hr Temp Adj 2 Random Plume Adj", "Bus Hr Temp Adj 2 Random", 
                   
                   "Bus Hr Temp Adj 1 Plume Adj", "Bus Hr Temp Adj 1", 
                   "Bus Hr Temp Adj 1 Random Plume Adj", "Bus Hr Temp Adj 1 Random", 
                   "Bus Hr Plume Adj",
                   "Bus Hr"
                   )

# drop random temporal adjustments
main_versions <- str_subset(version_levels, "Adj \\d Random", negate = T)

main_visits <- c(12)
alt_visits <- c(4)

main_cluster <- "cluster1"

reference_stationary_model <- "s_pncnoscreen_all_01"

# UW colors
uw_purple <- "#4b2e83"
uw_gold1 <- "#b7a57a" # web: e8e3d3
uw_gold2 <- "#85754d"

ref_model_col <- "darkgreen" #uw_gold2
annotation_line_size <-1.5

```

# reference stationary P-TRAK data

```{r}

stops_w %>%
  drop_na(pnc_noscreen) %>%
  group_by(location) %>%
  summarize(visits = n()) %>%
  summarize(
    min = min(visits),
    q25 = quantile(visits, 0.25),
    mean = mean(visits),
    q50 = quantile(visits, 0.50),
    max=max(visits)
  )%>%
  kable(caption = "distribution of visits per stop with unscreened P-TRAK readings") %>%
  kable_styling()

```


# model counts

```{r}
cw %>%
  filter(
    !cluster_type %in% c("cluster2", "cluster3"),
    !grepl("Random", version, ignore.case=T),
    visits %in% c(4, 12)
  ) %>% #filter(campaign==first(campaign)) %>% View()
  #prep_for_figs() %>%
  distinct(design, version, visits, cluster_type) %>% View()
     
  kable() %>%
  kable_styling()

# 112*30 #3360

```



# map

```{r}
# Define the bounding box for King County
bbox <- st_bbox(monitoring_area %>% st_buffer(10) )

# # Convert the bbox to a format suitable for osmdata
# bbox_vector <- c(bbox["xmin"], bbox["ymin"], bbox["xmax"], bbox["ymax"])

# Convert the bbox to a numeric vector suitable for osmdata and ggmap
bbox_vector <- c(as.numeric(bbox["xmin"]),
                 as.numeric(bbox["ymin"]),
                 as.numeric(bbox["xmax"]),
                 as.numeric(bbox["ymax"]))

# Create the query for major roads and get the data in sf format
major_roads <- opq(bbox_vector) %>%
  add_osm_feature(key = "highway", value = c(#"motorway", 
    #"trunk", 
                                             "primary"#, "secondary"
                                             )) %>%
  osmdata_sf() %>%
  .$osm_lines

#plot(major_roads[1])

##########################################
# x=unique(onroad_cov$cluster_type)[1]
lapply(unique(onroad_cov$cluster_type), function(x){
  onroad_cov %>%
    filter(cluster_type==x) %>%
    mutate(cluster_type = case_when(
      cluster_type == "cluster1" ~ "Main Clusters",
      cluster_type == "cluster2" ~ "Sensitivity (Larger) Clusters",
    )) %>%
    
    ggplot(aes(col=cluster_value), ) +
    facet_wrap(~cluster_type) + 
    annotation_map_tile(type = "osm", zoom = 11, alpha = 0.5) +  # Add OpenStreetMap tiles as background

    # roads
    geom_sf(data = major_roads, color = "gray", alpha=0.3) +
    # clusters
    geom_sf(size=0.5, show.legend=F) +
  
    # add scale & N arrow to top rught
    annotation_scale(location = "tr") +
    annotation_scale(location = "tr", unit_category ="imperial", pad_y = unit(0.55, "cm")) +
    annotation_north_arrow(location = "tr", pad_y = unit(0.5, "in"), style = north_arrow_fancy_orienteering) +
    
    theme_bw() +
    #theme_minimal() +
    theme(# remove the vertical grid lines
          panel.grid.major = element_blank()) + 
    scale_color_viridis_c() #+ labs(caption = "Map data © OpenStreetMap contributors")
  }) %>%
  ggarrange(plotlist = .) %>%
  annotate_figure(bottom = text_grob("Map data © OpenStreetMap contributors",
                                     hjust = 1, 
                                     x=1))

ggsave(file.path(image_path, "SI", "cluster_map.png"), width = 8, height = 8)

```

# Annual average estimates

```{r}
# table/boxplots of distribution
estimates <- all_predictions %>%
  filter(grepl("^s_", model)) %>%
  distinct(location, gs_estimate, prediction
           #spatial, 
           #adjusted, design, version, visits
           ) %>% 
  #drop_na() %>% 
  
  pivot_longer(cols = c(gs_estimate, prediction)) %>% 
  group_by(name) %>%
  summary_table(var = "value") 

estimates %>%
  kable(caption = "Distribution of estimated and all-data stationary model predicted annual average PNC at 309 stationary locations", 
      digits = 0,
      format.args = list(big.mark=",")
      ) %>%
kable_styling()


# predicted <- all_predictions %>%
#   filter(grepl("^r_", model)) %>%
#   left_join(cw) %>%  
#   group_by(#spatial, 
#     adjusted, design, version, visits) %>% 
#   summary_table(var = "prediction") 



########################################################################################
# plot


print("dashed line is median (IQR) predicted PNC from the all-data stationary model")
all_predictions %>%
  filter(model != ref_model_coefs$model) %>%
  prep_for_figs() %>% 

  group_by(version, design, visits, plume_adjustment, temporal_adjustment) %>%
  summary_table(var = "prediction") %>%
  
  ggplot(aes(x=plume_adjustment, fill=temporal_adjustment, linetype=visits)) +
  facet_grid(rows = vars(design), cols = vars(version), switch = "both") +

  geom_rect(inherit.aes = F, data = ref_prediction_distribution, aes(xmin=-Inf, xmax=Inf, ymin=q25, ymax=q75), alpha=0.2, fill=ref_model_col
            ) +
  geom_boxplot(position = "dodge", stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90,  
                                                        )) +
   geom_hline(yintercept = ref_prediction_distribution$median, alpha=0.8, size=annotation_line_size, col=ref_model_col, linetype=2) +
  scale_fill_viridis_d() +
  labs(x = NULL, 
       y = "Predicted PNC (pt/cm3)", 
       fill=NULL,
       linetype=NULL)

ggsave(file.path(image_path, "SI", "predicted_ufp_309_sites.png"), 
       #width = 22, height = 8
       width=10, height=10)

```


# Model R2

model eval is at 309 stationary sites


results           
* BH unadjusted R2 are all 0     
* All hours unadju are all 0 except for 1 value

# --> note: results are totally different now  for the 4-visit results for clustered analyses? things look better w/ new clusters? 


```{r, fig.height=8, fig.with=8}
stationary_r2_mse_ref <- ref_model_coefs$MSE_based_R2

print(paste("reference model R2 is the all-data stationary model:", round(stationary_r2_mse_ref, 2)))

# x=main_visits
lapply(c(main_visits, alt_visits), function(x){
  
  model_eval %>%
    filter(grepl(x, visits)) %>%
    prep_for_figs(
      #default to use whatever I specify above
      visits_to_keep=c(1:100)) %>%
    
    group_by(version, design, visits, temporal_adjustment, plume_adjustment, cluster_type) %>%
    summary_table(var = "MSE_based_R2") %>% 
    mutate(design = factor(design, levels=design_levels)) %>%
  
    ggplot(aes(linetype=plume_adjustment,
               fill=temporal_adjustment, 
               x=version)) +
    facet_grid(rows = vars(design),
               cols=vars(plume_adjustment, visits),
               switch = "both", scales="free_x",space="free") +
    geom_hline(yintercept = stationary_r2_mse_ref, linetype=2, col=ref_model_col, 
               #size=annotation_line_size
               ) +
      geom_rect(inherit.aes = F, xmin=-Inf, xmax=Inf, ymin=0.6, ymax=Inf, alpha=0.05, fill=ref_model_col) +
  
    geom_boxplot(position = "dodge", stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90)) +
    scale_y_continuous(sec.axis = sec_axis( trans=~./stationary_r2_mse_ref, name="Proportion of Reference Model R2") ) +
    scale_fill_viridis_d() +
    labs(y = "MSE-based R2") +
  labs(x=NULL, fill=NULL, linetype=NULL)  
  
  if(x==main_visits){
    ggsave(file.path(image_path, paste0("r2_mse_",x ,"visits.png")), width = 10, height = 10)
    }else{
      ggsave(file.path(image_path, "SI", paste0("r2_mse_",x ,"visits.png")), width = 10, height = 10)
      }
})

#############################################
# SI: plot comparing cluster 1 vs 2 - show results are similar

cluster_designs <- str_subset(design_levels, "Cluster|Road Type")

model_eval %>%
  prep_for_figs(cluster_to_keep = c("cluster1", "cluster2"), 
                designs_to_keep = cluster_designs) %>%
  drop_na(cluster_type) %>%
         
  group_by(version, design, visits, temporal_adjustment, plume_adjustment, cluster_type) %>%
  summary_table(var = "MSE_based_R2") %>% 
  mutate(design = factor(design, levels=design_levels),
         cluster_type = ifelse(cluster_type==main_cluster, paste(main_cluster, "(Main)"), cluster_type)) %>%
  
    filter(grepl("Not", plume_adjustment)) %>%


  ggplot(aes(linetype=plume_adjustment,
             fill=temporal_adjustment, #linetype=visits
             x=version)) +
  facet_grid(rows = vars(design),
             cols=vars(cluster_type#, plume_adjustment, visits
                       ),
             switch = "both", scales="free_x",space="free") +
  geom_hline(yintercept = stationary_r2_mse_ref, linetype=2, col=ref_model_col) +
    geom_rect(inherit.aes = F, aes(xmin=-Inf, xmax=Inf, ymin=0.6, ymax=Inf), alpha=0.05, fill=ref_model_col) +

  geom_boxplot(position = "dodge", stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90)) +
  scale_y_continuous(sec.axis = sec_axis( trans=~./stationary_r2_mse_ref, name="Proportion of Reference Model R2") ) +
  scale_fill_viridis_d() +
  labs(y = "MSE-based R2") +
labs(x=NULL, fill=NULL, linetype=NULL)  
  
ggsave(file.path(image_path, "SI", paste0("r2_mse_12visits_noplumeadj_cluster_comp.png")), width = 10, height = 8)


#############################################
# SI: same plot just for routes - show that get similar results w/ increasing numbers
# Prepare the data
data <- model_eval %>%
  prep_for_figs(designs_to_keep = "Route",
                visits_to_keep = c(1:99)) %>%
  group_by(version, design, visits, temporal_adjustment, plume_adjustment, cluster_type) %>%
  summary_table(var = "MSE_based_R2") %>%
  mutate(design = factor(design, levels = design_levels),
         visits = factor(visits, levels = paste(c(1:20), "visits")))

rec_good_r2 <- expand.grid(unique(data$plume_adjustment),
                           unique(data$version),
                           xmin = -Inf, xmax = Inf, ymin = 0.6, ymax = Inf)

# Create the plot
ggplot(data, aes(linetype = plume_adjustment, fill = temporal_adjustment, x = visits)) +
  facet_grid(rows = vars(design, version),
             cols = vars(plume_adjustment),
             switch = "both", scales = "free_x", space = "free") +
  geom_hline(yintercept = stationary_r2_mse_ref, linetype = 2, col = "black") +  # Replace with appropriate color if needed
  # geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 0.6, ymax = Inf), inherit.aes = FALSE, alpha = 0.1, fill = ref_model_col) +
  geom_rect(inherit.aes = FALSE, 
            data = rec_good_r2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), alpha = 0.05, fill = ref_model_col) +

    geom_boxplot(position = "dodge", aes(ymin = Q10, lower = Q25, middle = Q50, upper = Q75, ymax = Q90), stat = "identity") +
  scale_y_continuous(sec.axis = sec_axis(trans = ~./stationary_r2_mse_ref, name = "Proportion of Reference Model R2")) +
  scale_fill_viridis_d() +
  labs(y = "MSE-based R2", x = NULL, fill = NULL, linetype = NULL)

ggsave(file.path(image_path, "SI", paste0("r2_mse_route_visits_comp.png")), width = 10, height = 8)

```

# --> why do routes still look good w/ reg-based R2 less variabiltiy in predictions?

regression-based R2 comparison 

```{r}
#############################################
stationary_r2_reg_ref <- ref_model_coefs$reg_based_R2
print(paste("reference model R2 is the all-data stationary model:", round(stationary_r2_reg_ref, 2)))

r2_values <- data.frame(name=c("Regression-based R2",
                               "MSE-based R2 (Main)"),
                        value = c(ref_model_coefs$reg_based_R2,
                                  ref_model_coefs$MSE_based_R2))

rec_good_r2 <- expand.grid(unique(data$plume_adjustment),
                           unique(data$design),
                           xmin = -Inf, xmax = Inf, ymin = 0.6, ymax = Inf)


model_eval %>%
  prep_for_figs(designs_to_keep = c("Balanced", "Route")) %>% 
  pivot_longer(cols = contains("R2")) %>%
  
  group_by(version, design, visits, temporal_adjustment, plume_adjustment, cluster_type, name) %>%
  summary_table(var = "value") %>% 
  mutate(design = factor(design, levels=design_levels),
         name = ifelse(name=="MSE_based_R2", "MSE-based R2 (Main)", "Regression-based R2")) %>%

  ggplot(aes(linetype=plume_adjustment,
             fill=temporal_adjustment, 
             x=version)) +
  facet_grid(rows = vars(design),
             cols=vars(name#, visits
                       ),
             switch = "both", scales="free_x",space="free") +
  #geom_hline(yintercept = stationary_r2_mse_ref, linetype=2, col=ref_model_col) +
  geom_hline(#inherit.aes = FALSE, 
             data= r2_values, aes(yintercept = value), linetype=2, col=ref_model_col) +
     geom_rect(inherit.aes = FALSE, 
            data = rec_good_r2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), alpha = 0.05, fill = ref_model_col) +

  geom_boxplot(position = "dodge", stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90)) +
  scale_y_continuous(sec.axis = sec_axis( trans=~./stationary_r2_mse_ref, name="Proportion of Reference Model R2") ) +
  scale_fill_viridis_d()+
  labs(y = "R2") +
labs(x=NULL, fill=NULL, linetype=NULL)  

# --> interesting: using reg-R2 does not show the reduced prediction accuracy like MSE_based R2 since estimate-prediction pair values are still linearly associated (but predictions are higher?)

#  reg-based R2 is only minimally impacted for balanced vs route designs

ggsave(file.path(image_path, "SI", "r2_reg_12v_example.png"), width = 8, height = 6)


```

?? lms 

```{r}

fit_r2_lm <- function(y="MSE_based_R2",
                      x = c("design", "version", "plumed_adjusted", "visits")
                      ){
  
  lm_formula <- paste(y, "~", paste(x, collapse = "+"))
  
  model_eval %>%
  filter(!grepl("Random", version),
         visits %in% c(4,12)) %>%
  mutate(
    version = gsub(" Plume Adj", "",  version),
    design = factor(design, levels=rev(design_levels)),
    plumed_adjusted = factor(adjusted, levels=c("Unadjusted", "Adjusted"))) %>%
  
  lm(as.formula(lm_formula), data=.)

}


# units of analysis are the campaign-specific R2 (30 per design-version-etc.)
# mse-based R2 ~ design_features
fit_r2_lm() %>% 
  broom::tidy()

# reg-R2
fit_r2_lm(y = "reg_based_R2") %>% 
  broom::tidy()

```


# Participant Exposrue Predictions 

comparison of predicted 5 yr exposures at baseline

# --> ERROR: memory exhauasted

```{r, fig.height=8, fig.with=10}
# reference design
ref_cs <- filter(cs, model %in% ref_model_coefs$model) 

ref_cs %>% 
  summarize(
    N = n(),
    Participants = length(unique(study_id)),
    Campaigns = length(unique(campaign)),
    Min = min(exposure),
    Q05 = quantile(exposure, 0.05),
    Q25 = quantile(exposure, 0.25),
    Q50 = quantile(exposure, 0.50),
    Q75 = quantile(exposure, 0.75),
    Q95 = quantile(exposure, 0.95),
    Max = max(exposure)) %>%
  kable(caption = "Distribution of Predicted UFP (pt/cm3) exposure from the reference All data stationary exposure model", digits = 0, format.args = list(big.mark=",")) %>%
  kable_styling()


ref_cs_distribtuion <- ref_cs  %>%
  summarize(n = n(),
            median = median(exposure),
            q25 = quantile(exposure, 0.25),
            q75 = quantile(exposure, 0.75))  
# plot
print("dashed lines are the median (IQR) predicted PNC for participants from the all-data stationary model")
cs %>%
  filter(!model %in% ref_model_coefs$model) %>%
  mutate(visits = paste(visits, "visits"),
         design = factor(design, levels = design_levels),
         version = factor(version, levels = version_levels),
         ) %>%
  
  group_by(version, design, visits) %>%
  summary_table(var = "exposure") %>%
   
  ggplot(aes(x=version, fill=design)) +
  geom_boxplot(position = "dodge", stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90)) +
  facet_wrap(~visits, scales="free_x", ncol = 1) +
  geom_hline(yintercept = ref_cs_distribtuion$median, linetype=2, alpha=0.5) +
  geom_hline(yintercept = c(ref_cs_distribtuion$q25, ref_cs_distribtuion$q75), linetype=3, alpha=0.3) +
  labs(fill="Location Visit\nSelection",
       y = "Predicted PNC (pt/cm3)"
       )  

ggsave(file.path(image_path, "SI", "cohort_5yr_exposure_comparisons.png"), width = 8, height = 8)

```


# Health effect estimates (CASI-IRT)

```{r}
ref_model_coefs %>%
  select(model, est, lower, upper, MSE_based_R2, reg_based_R2) %>%
  kable(caption = "health estimate from the reference all-data stationary exposure model", 
        digits = 3) %>%
  kable_styling()

```

```{r, fig.height=10, fig.with=10}
# function to produce main health results figures

health_plot <- function(dt=model_coefs,
                        designs_to_keep.=c("Balanced", "Route"),
                        visits_to_keep.=c(4,12),
                        ref_stationary_restimate=tot_pnc){
  # ref_stationary_estimate <- data.frame( label = c("Reference", "No Association"),
  #                    est=c(ref_stationary_restimate, 0),
  #                    x=1.5)   

  
  dt %>%
  prep_for_figs(designs_to_keep = designs_to_keep.,
                visits_to_keep = visits_to_keep.) %>%
  
  group_by(version, design, visits, temporal_adjustment, plume_adjustment, cluster_type) %>%
  summary_table(var = "est") %>% 

    ggplot(aes(linetype=plume_adjustment,
               fill=temporal_adjustment, 
               x=version)) +
    facet_grid(rows = vars(design),
               cols=vars(visits, plume_adjustment),
               switch = "both", scales="free_x",space="free") +
 geom_hline(yintercept = ref_stationary_restimate, linetype=2, col=ref_model_col, size=annotation_line_size) +
  geom_hline(yintercept = 0, linetype=4, col="red", size=annotation_line_size) +
  
    geom_boxplot(position = "dodge", stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90)) +
  scale_y_continuous(sec.axis = sec_axis(trans=~(.-ref_stationary_restimate)/-ref_stationary_restimate, name="Health Point Estimate % Difference", labels = scales::percent), 
                     position="left") +
   # geom_label(inherit.aes = F,
   #            data=ref_stationary_estimate, aes(x=x, y=est, label=label), fill= "white",show.legend = F, size=5) + 
 
  scale_fill_viridis_d() +
  labs(y = "Health Point Estimate",
       fill=NULL,
       x = NULL, linetype=NULL) 
  
}

# extended/main health models
health_plot(dt=model_coefs)  

ggsave(file.path(image_path, "ufp_health_estimate.png"), width = 10, height = 8)

## same as above for reduced health  model
health_plot(dt=model_coefs_reduced_model, 
            ref_stationary_restimate = tot_pnc_reduced)  

ggsave(file.path(image_path, "SI", "ufp_health_estimate_redued_model.png"), width = 10, height = 8)

```

```{r}
# same as above for routes
health_plot_for_routes <- function(dt=model_coefs,
                        designs_to_keep.=c("Route"),
                        visits_to_keep.=c(1:99),
                        ref_stationary_restimate=tot_pnc){

  dt %>%
  prep_for_figs(designs_to_keep = designs_to_keep.,
                visits_to_keep = visits_to_keep.) %>%
  
  group_by(version, design, visits, temporal_adjustment, plume_adjustment, cluster_type) %>%
  summary_table(var = "est") %>% 

    ggplot(aes(linetype=plume_adjustment,
               fill=temporal_adjustment, 
               x=visits)) +
    facet_grid(rows = vars(design),
               cols=vars(version, #plume_adjustment
                         ),
               switch = "both", scales="free_x",space="free") +
 geom_hline(yintercept = ref_stationary_restimate, linetype=2, col=ref_model_col, size=annotation_line_size) +
  geom_hline(yintercept = 0, linetype=4, col="red", size=annotation_line_size) +
  
    geom_boxplot(position = "dodge", stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90)) +
  scale_y_continuous(sec.axis = sec_axis(trans=~(.-ref_stationary_restimate)/-ref_stationary_restimate, name="Health Point Estimate % Difference", labels = scales::percent), 
                     position="left") +
    scale_fill_viridis_d() +
    labs(y = "Health Point Estimate",
       fill=NULL,
       x = NULL, linetype=NULL) 
  
}

health_plot_for_routes()

ggsave(file.path(image_path, "SI", "ufp_health_estimate_route_visits.png"), width = 12, height = 6)

```


