---
title: "Epi results using stationary data exposure models"
author: "Magali Blanco"
date: ' `r Sys.time()` '
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
    number_sections: true
    toc_float: true
    collapsed: false
    smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

# Setup 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      cache=F, cache.comments = F, 
                      message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE#, fig.height = 10, fig.width = 10
                      )  

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
           detach, character.only=TRUE, unload=TRUE, force=TRUE))}

pacman::p_load(tidyverse, 
               PRISMAstatement,table1,
               knitr, kableExtra,
               ggpubr, #ggarrange()
               ggmap, sf, #mapping
               ggspatial, #mapping, adding scales, N arrows...
               spData, # us_states data - mapping WA state
               cowplot #layering ggplots. ggdraw(), draw_plot()
               )    

dt_path <- file.path("Output", readRDS(file.path("Output", "latest_dt_version.rda")))

set.seed(1)

source("functions.R")
output_data_path <- file.path(dt_path, "epi")

image_path <- file.path("..", "Manuscript", "Images", "v4") # "v3_20230321")

if(!dir.exists(file.path(image_path, "other", "presentation"))) {dir.create(file.path(image_path, "other", "presentation"), recursive = T)}
if(!dir.exists(file.path(image_path, "other", "poster"))) {dir.create(file.path(image_path, "other", "poster"), recursive = T)}
if(!dir.exists(file.path(image_path, "SI"))) {dir.create(file.path(image_path, "SI"), recursive = T)}

# ggplot settings
theme_set(theme_bw())
theme_update(legend.position = "bottom")


##################################################################################################
# COMMON VARIABLES 
##################################################################################################
all_pollutants <- readRDS(file.path(output_data_path, "main_pollutants.rda"))

version_examples <- c("4", "12",  #visits/site
                      "1", #"3", #1 & 4 seasons
                      "Bus", "Rush", "Bus Adj", "Rush Adj",
                      "H22 L2", "H2 L22" #visit type
                      )
drop_site_types <- "H 8|H 4|H 10|H 14|H 16|H 20|L 8|L 4|L 10|L 14|l 16|L 20"

#for boxplots
bp_min <- 0.025
print(paste("Qmin in tables is", bp_min))
bp_max <- 0.975
print(paste("Qmax in tables is", bp_max))

one_to_one_band <- 0.2

#reference estimates
# --> OK that ref says "more restrictive or less bal"?
# ref_model_coefs <- model_coefs %>%
#   filter(design=="All Data")
# ggsave(ref_model_coefs, file.path())

# UW colors
uw_purple <- "#4b2e83"
uw_gold1 <- "#b7a57a" # web: e8e3d3
uw_gold2 <- "#85754d"

##################################################################################################
# LOAD DATA
##################################################################################################
# exposure model crosswalks (cw)
## first set of designs

# cw0 <- read.csv(file.path(dt_path, "other_designs_model_cw_20240516.csv"))

cw <- read.csv(file.path(dt_path, "model_cw.csv")) %>%
  filter(design %in% c("full", "fewer total stops") |
           # these sensitivity & secondary analyses don't have a temporal adjustment
           design == "fewer hours" & grepl("ns10100|no2", model)) %>%
  ## other designs (includes updated temp adj 1)
  bind_rows(read.csv(file.path(dt_path, "other_designs_model_cw_20240516.csv"))) %>%
  select(-model_no) %>%
  filter(variable %in% all_pollutants,
         !grepl(drop_site_types, version)
         )

###################
# --> TEMP FOR MERGING W/ existing (non-updated) 'cs' data
temp_cw <- cw %>%
  filter(grepl("_bh|_rh", model)) %>% 
  mutate(
    model = gsub("adj1|adj2", "adj", model),
    #5/20/24
    model = gsub("fewhrs_", "", model),
    # model = gsub("bh", "fewhrs_bh", model),
    # model = gsub("rh", "fewhrs_rh", model),
    
    version_code = gsub("adj1|adj2", "adj", version_code),
    version = gsub("adj 1|adj 2", "adj", version))

cw <- bind_rows(cw, temp_cw) %>%
  # filter(#!grepl("fewhrs", model)
  #        !grepl("nstot_bh|nstot_rh", model)
  #        )
  mutate(model=gsub("adj1", "adj", model))


# unique(test$model)[!unique(test$model) %in% cw$model] %>% as.data.frame() %>% filter(grepl("pncnoscreen_b", .)) 
# test %>% filter(study_id==first(study_id), grepl("pnc", model)) %>% View()
# 
# test %>%
#   filter(study_id==first(study_id)) %>%
#   mutate(model = substr(model, 1, nchar(model)-3)) %>%  
#   filter(!grepl("_all|_balsea|v_|sitetype", model),
#          grepl("ns10100|pnc|nstot", model)
#          ) %>% 
#   
#   distinct(model) %>% View()

###################



##################################################################################################
  
# test <- readRDS(file.path(dt_path, "Selected Campaigns", "selected_campaigns_v2.rda"))
# model_eval <- readRDS(file.path(dt_path, "Selected Campaigns", 
#                                            # "selected_campaigns_v2.rda" # where did this come from???
#                                            "selected_campaigns.rda")) %>%

# exposure MODEL EVAL
# exposure model performances for other designs
model_eval_other_designs0 <- readRDS(file.path(dt_path, "other_designs_model_eval_20240516.rda")) %>%
   select(-no_sites) %>%
  
  #-->TEMP UNTIL UPDATE DATASET
  mutate(model = gsub("adj1|adj2", "adj", model))

# combine  
model_eval <- readRDS(file.path(dt_path, "model_eval.rda")) %>%
  filter(reference == "gs_estimate",
         design %in% c("full", "fewer total stops") |
           # sensitivity/secondary analyses don't have a temporal adjustment
           design == "fewer hours" & grepl("ns10100|no2", model)) %>%
  select(names(model_eval_other_designs0)) %>%
  bind_rows(model_eval_other_designs0) %>%
  left_join(cw, by="model") %>%
  filter(variable %in% all_pollutants) %>%
  #only show a few of the site types
  filter(!grepl(drop_site_types, version)) %>%
  #remove "temp adj 1 vs 2.." since only 1 option here
  mutate(version = gsub("adj 1|adj 2", "adj", version)) %>%
  label_pollutants() %>% label_designs()  %>%
  mutate(
    ref = ifelse((design == "Fewer Visits" & version == "12") |
                   (design == "Fewer Seasons" & version == "4") |
                   (design == "Unbalanced Visits" & version == "H12 L12"), "Balanced/More Data", "Unbalanced/Less Data")) 

#rm(model_eval_other_designs0)

##################################################################################################  
# --> will want to update this w/ new exposres: updated temporal adjustment (also includes pnc_noscreen)
# test <- readRDS(file.path(output_data_path, "dt_for_cross_sectional_analysis.rda")) %>% rename(exposure = avg_0_5_yr) 
# test0 <- test %>% filter(study_id == first(study_id))
# test0 %>% filter(grepl("bh", model)) %>% View()


# test %>% left_join(select(cw, model, variable, design, version, campaign), by="model") %>% filter(is.na(design)) %>% View()

# --> TEMP there may still be a merging issue where some pnc_noscreen models have NAs..
cs <- readRDS(file.path(output_data_path, "dt_for_cross_sectional_analysis.rda")) %>%
  rename(exposure = avg_0_5_yr) %>%
  
  # --> TEMP (CHANGE TO RIGHT_JOIN WHEN UPDATE)
  #right_join(select(cw, model, variable, design, version, campaign), by="model") %>%
  left_join(select(cw, model, variable, design, version, campaign), by="model") %>% #filter(is.na(design)) %>% View()
  
  # new 5/17/14
  label_pollutants() %>% label_designs() %>%
  
  ################################
  # --> TEMP shouldn't matter/delete later when do right_join?
  drop_na(exposure) %>%
  filter(!grepl("nstot_bh|nstot_rh", model),
         #NOT WORKING?
         !grepl(drop_site_types, version) 
         ) %>%
  drop_na(design)
 
  ################################
  
# test2 <- cs %>% filter(study_id == first(study_id))
# test2 %>% filter(grepl("tot", model)) %>% View()
# test2 %>% filter(grepl("bh", model)) %>% View()
# test2 %>% filter(is.na(design)) %>% View()

##################################################################################################
model_coefs0 <- readRDS(file.path(output_data_path, "model_coefs.rda")) %>%
  # make sure the latest model performances are used
  select(-c(out_of_sample, reference, RMSE, contains("R2")))

model_coefs <- model_coefs0 %>% 
  filter(model %in% unique(cs$model), #model_eval$model
         # drop old/duplicate models
         #!grepl("nstot_bh|nstot_rh|pncnoscreen_bh|pncnoscreen_rh", model)
         !grepl("nstot_bh|nstot_rh", model)) %>%
  label_pollutants() %>% label_designs() %>%
   mutate(
    ref = ifelse((design == "Fewer Visits" & version == "12") |
                   (design == "Fewer Seasons" & version == "4") |
                   (design == "Unbalanced Visits" & version == "H12 L12"), "Balanced/More Data", "Unbalanced/Less Data")) 


# sensitivity health analyses
model_coefs_sensitivity <- readRDS(file.path(output_data_path, "model_coefs_sensitivity.rda")) %>% #View()
  # make sure the latest model performances are used
  select(-c(out_of_sample, reference, RMSE, contains("R2"))) %>% 
  # filter(model %in% unique(cs$model), #model_eval$model,
  #        # drop old/duplicate models
  #        !grepl("nstot_bh|nstot_rh", model),
  #        # just focus on the NS for now
  #        grepl("total", variable)) %>%

  #filter(grepl("s_nstot", model)) %>%
  
  
  
  label_pollutants() %>% label_designs() %>%
   mutate(
    ref = ifelse((design == "Fewer Visits" & version == "12") |
                   (design == "Fewer Seasons" & version == "4") |
                   (design == "Unbalanced Visits" & version == "H12 L12"), "Balanced/More Data", "Unbalanced/Less Data")) 


exclusion_table <- read.csv(file.path(output_data_path, "exclusion_table2024-05-20.csv"))

#issue 12 reference models
model_coefs_issue12 <- readRDS(file.path(output_data_path, "model_coefs_issue12.rda"))


##################################################################################################
# annual estimates
# annual estimates: site type
annual_site_type <- readRDS(file.path(dt_path, "annual_site_type.rda")) %>%
  select(-no2) %>%
  # ? only visualize a few?
  filter(!grepl(drop_site_types, version)) 

# annual estimates: fewer season
annual_fixed_seasons <- readRDS(file.path(dt_path, "fixed_season_annual.rda"))  %>%
  select(-no2)

# annual estimates: fewer hours & temporal adjustment (for total NS & P-TRAK (no 10-100 nm))
annual_temp_adj <- readRDS(file.path(dt_path, "temporal_adjustment.rda")) %>%
  mutate(visits=12)

# full, fewer visits, fewer hours  
annual_trainint_set0 <- readRDS(file.path(dt_path, "annual_training_set.rda")) 

# annual estimates: fewer hours for 10-100 (no temporal adj available)
annual_non_temp_adj <- annual_trainint_set0 %>%
  filter(design %in% c("fewer hours")) %>% 
  select(location, ns_10_100, #pnc_noscreen, 
         no2,
         visits, campaign, design, version, spatial_temporal)
## combine
fewr_hrs <- left_join(annual_temp_adj, annual_non_temp_adj)

# annual estimates: combine everything
annual_trainint_set <- annual_trainint_set0 %>%
  filter(design %in% c("full", "fewer total stops")) %>%
  select(#-no2, 
         -spatial_temporal) %>%
  bind_rows(annual_site_type) %>%
  bind_rows(annual_fixed_seasons) %>% 
  bind_rows(fewr_hrs)

##################################################################################################
# site predictions
## all data, fewer visits
predictions0 <- readRDS(file.path(dt_path, "UK Predictions", "all_predictions.rda")) %>%
  filter((design %in% c("full", "fewer total stops") |
            design == "fewer hours" & grepl("no2", variable)),
         variable %in% all_pollutants) %>%
  left_join(cw)

# combine predictions
## other designs: unbalanced, temporally adjusted, fixed balanced seasons...
predictions <- readRDS(file.path(dt_path, "UK Predictions", 
                                                   #"other_design_predictions.rda"
                                                   "other_design_predictions_20240516.rda"
                                                   )) %>%
  filter(grepl("nstot|noscreen", model),
          variable %in% all_pollutants) %>% 
  
  # --> TEMP
  mutate(model = gsub("adj1|adj2", "adj", model)) %>%
  
  left_join(cw) %>%
  ## add original designs
  bind_rows(select(predictions0, names(.))) %>%
  
  label_pollutants() %>% label_designs() %>%
  #select(design, version, campaign, location, gs_estimate, campaign_estimate, prediction) %>% 
  mutate(adjusted = ifelse(grepl("adj", model), "Adjusted", "Unadjusted"),
         adjusted = factor(adjusted, levels=c("Unadjusted", "Adjusted")),
         version = gsub("Adj | Adj 1|Adj 2", "", version)) %>%
  mutate(error = prediction - gs_estimate,
         #absolute error
         error = abs(error)) 



# number of visits (stops) per site 
stops_w <- readRDS(file.path(dt_path, "stops_used.rda"))

##################################################################################################
# COMMON VARIABLES 2
##################################################################################################
all_pollutants_labels <- unique(model_eval$variable)
main_pollutants_labels <- all_pollutants_labels[str_detect(all_pollutants_labels, "Total")]
sensitivity_pollutant_labels <- all_pollutants_labels[str_detect(all_pollutants_labels, "Total|10-100|100|20-1,000")]

# x-axis labels for posters
version_levels2 <- setdiff(levels(model_eval$version), c("Business", "Rush")) %>%
  append(c("Business",
         "Business \nTemporally\nAdjusted",
         "Rush",
         "Rush \nTemporally\nAdjusted"))

design_labels <- unique(model_eval$design) %>% 
  # drop?
  setdiff("All Data")
# arrange designs
design_labels <- levels(model_eval$design)[levels(model_eval$design) %in% design_labels]

local_tz <- "America/Los_Angeles"

```

# Study Dates 


```{r}
range(cs$visitdt)

```

# QC variables

these QC variable values from the exposure (issue 17) & health (issue 12) dataset should be identical or very similar, and they are. 

```{r}
# names(cs)
qc_vars <- c("exp_coverage", "avg_wc_ufp_10_42_MM_05_yr",
           "exact_coverage", "avg_ec_ufp_10_42_MM_05_yr",
           "imp_coverage", "avg_ic_ufp_10_42_MM_05_yr", 
           "imputation_quality", "avg_iq_ufp_10_42_MM_05_yr")

cs %>%
  # person-level dataset
  select(study_id, all_of(qc_vars)) %>%
  distinct() %>%
  pivot_longer(cols = -study_id, names_to = "var", values_to = "value") %>%
  mutate(var=factor(var, levels=qc_vars)) %>%
  group_by(var) %>% 
  # 1 person has 4 QC variables missing
  drop_na(value) %>%
  summarize(
    N = n(),
    Min = min(value),
    Q25 = quantile(value, 0.25),
    Median = median(value),
    Mean = mean(value),
    Q75 = quantile(value, 0.75),
    Max = max(value)
  ) %>%
  kable(caption = "QC variables", digits = 2) %>%
  kable_styling()

# highest IQ value
distinct(cs, study_id, avg_iq_ufp_10_42_MM_05_yr) %>%
  drop_na(avg_iq_ufp_10_42_MM_05_yr) %>%
  summarize(
    n = n(),
    iq0 = sum(avg_iq_ufp_10_42_MM_05_yr==0)/n,
    iq1 = sum(avg_iq_ufp_10_42_MM_05_yr==1)/n,
    iq2 = sum(avg_iq_ufp_10_42_MM_05_yr==2)/n,
  )%>%
  kable(caption = "proportion of participants with varying imputation qualities", digits = 3) %>%
  kable_styling()

```



# Exposure

## visits per site in the "all data" reference campaign
note that these "visits" are based on the NanoScan (different for on-road data based on P-TRAK data)

```{r}
stops_w %>%
  drop_na(ns_total_conc) %>%
  #drop_na(pnc_noscreen) %>%
  
  group_by(location) %>%
  summarize(visits = n()) %>%
  summarize(
    min = min(visits),
    q25 = quantile(visits, 0.25),
    mean = mean(visits),
    q50 = quantile(visits, 0.50),
    max=max(visits)
  ) %>%
  kable(caption = "distribution of visits per stop with NanoScan readings") %>%
  kable_styling()

```



## Site annual averages


```{r}
annual_avgs <- annual_trainint_set %>%
  pivot_longer(cols = starts_with(c("pnc_", "ns_")), names_to = "variable", values_to = "value") %>%
  #temp adj is only for NS total
  drop_na(value) %>%
  filter(variable %in% all_pollutants) %>%
  label_pollutants(label = "ufp_range") %>%
  label_designs() %>%
  mutate(primary = ifelse(grepl("10-420", variable), "Primary", "Sensitivity"))

annual_avgs %>%
  group_by(design, version, variable) %>%
  summarize(
    n = n(),
    Min = min(value),
    Q25 = quantile(value, 0.25),
    Median = median(value),
    Mean = mean(value),
    Q75 = quantile(value, 0.75),
    Max = max(value)
  ) %>%
  kable(format.args = list(big.mark = ","), digits = 0) %>%
  kable_styling()

print("distribution of annual average site estimates used to develop exposure models")
annual_avgs %>%
  group_by(version, design, instrument, variable) %>%
  summary_table(var = "value") %>%  
  
  mutate(
    version = gsub("Bus", "Business", version),
             version = gsub(" Adj 1", " \nTemporally\nAdjusted", version),
             version = factor(version, levels= version_levels2)) %>% #View()
  

  ggplot(aes(x=version, col=interaction(instrument, variable, sep = " "))) +
  geom_boxplot(position = "dodge", stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90)) +
  facet_wrap(~design, scales="free_x", switch = "x", ncol = 2)+
  labs(y = "PNC (pt/cm3)", x="Version", col="Measure", fill="Analysis")

ggsave(file.path(image_path, "SI", "site_averages.png"), width = 8, height = 8)

```


## Model R2

### --> why do model R2 tell diff story than betas? are exposure model reference values a different distribtuion than the cohort? e.g., are more ppl living near/away form locations where exposure predictions improve/worsen? i.e., what are the places that do particularly bad/good with temporal adjustment? 

**do ppl do weighted avgs when calculationg model R2? weighted by amount of ppl near a location (i.e., how representative is a location relative to the cohort of interest?)**

30 campaigns per design-version-pollutant 

```{r}
t2 <- model_eval %>%
  filter(variable %in% main_pollutants_labels) %>%
  group_by(variable, design, version) %>%
  alt_boxplot(var = "MSE_based_R2", min_q=bp_min, max_q=bp_max) %>%
  ungroup()

t2 %>%
  kable(caption = "Distribution of MSE-based R2 for each design", 
        digits = 2) %>%
  kable_styling()

print("dashed line is the All Data design performance")

refs1 <- model_eval %>%
  filter(design=="All Data", 
         grepl("All", design),
         variable %in% sensitivity_pollutant_labels) %>%
  select(variable, MSE_based_R2, reg_based_R2) %>%
  mutate(variable = ifelse(grepl("Total", variable), "10-420 nm (Primary)", as.character(variable)),
         variable = factor(variable, levels = c("10-420 nm (Primary)", "10-100 nm", "20-1,000 nm")))

# r2_ref <- refs1 %>%
#   filter(grepl("Primary", variable, ignore.case=T)) %>%
#   pull(MSE_based_R2)
# 
# r2_regression_ref <- refs1 %>%
#   filter(grepl("Primary", variable, ignore.case=T)) %>%
#   pull(reg_based_R2)

# label position is close enought for either R2
temp <- data.frame(design=c("Fewer Visits"),
                   label = c("All-Data Reference Model"),
                   #est=c(r2_ref),
                   version = "6") %>%
  mutate(design = factor(design, levels = levels(model_eval$design)))
  
# main analyses
# dt=model_eval
# y_variable="MSE_based_R2"
# y_variable="reg_based_R2"
r2_plot <- function(dt=model_eval, y_variable) {
  ref_r2 <- refs1 %>%
    filter(grepl("10-420", variable)) %>%
    pull(get(y_variable))
  
  dt %>%
    filter(variable %in% main_pollutants_labels,
           design != "All Data") %>%
      mutate(version = gsub("Bus", "Business", version),
             version = gsub(" Adj", " \nTemporally\nAdjusted", version),
             version = factor(version, levels= version_levels2),
             
             variable = ifelse(grepl("Total", variable), "10-420 nm (Primary)", as.character(variable)),
             variable = factor(variable, levels = c("10-420 nm (Primary)", "10-100 nm", "20-1,000 nm")),
             analysis = ifelse(grepl("10-420", variable), "Primary", "Sensitivity")) %>%
    group_by(version, design, ref) %>%
    summary_table(var = y_variable) %>%
    ggplot(aes(x=version, fill=ref)) +
    geom_boxplot(stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90)) +
    geom_hline(yintercept = ref_r2, linetype=2, alpha=0.5, ) +
    facet_wrap(~design, scales = "free_x", switch = "x") + 
    geom_label(data=temp, aes(y=ref_r2, label=label), fill= "white",show.legend = F, size=3) +
    
    scale_y_continuous(sec.axis = sec_axis(trans=~./ref_r2, name="PNC Exposure Model R2 (% of Reference Model)", labels = scales::percent), position="right") +
      
    labs(y = "PNC Exposure Model R2", x = "Design", fill=NULL)
}

# model_eval %>%
#   mutate(version = gsub("Bus", "Business", version),
#          version = gsub(" Adj", " \nTemporally\nAdjusted", version),
#          version = factor(version, levels= version_levels2)) %>%
#   r2_plot(dt=., y_variable = "MSE_based_R2")



r2_plot(y_variable = "MSE_based_R2")
ggsave(file.path(image_path, "r2.png"), width = 8, height = 7)

# have this below
# r2_plot(y_variable = "reg_based_R2")
# ggsave(file.path(image_path, "SI", "r2_regression_based.png"), width = 8, height = 6)

################################################################################
# SI Plots - sensitivity analyses
r2_plot_multifacet <- function(dt=model_eval, y_variable, facet_variable) {
  
  ref_r2 <- refs1 %>%
    filter(variable==facet_variable) %>%
    pull(get(y_variable))
  
  dt %>%
    filter(design != "All Data") %>%
      mutate(version = gsub("Bus", "Business", version),
             version = gsub(" Adj", " \nTemporally\nAdjusted", version),
             version = factor(version, levels= version_levels2),
            
             variable = ifelse(grepl("Total", variable), "10-420 nm (Primary)", as.character(variable)),
             variable = factor(variable, levels = c("10-420 nm (Primary)", "10-100 nm", "20-1,000 nm")),
             analysis = ifelse(grepl("10-420", variable), "Primary", "Sensitivity")) %>%
    filter(variable == facet_variable) %>%
  
    group_by(version, design, variable, ref) %>%
    summary_table(var = y_variable) %>%
    ggplot(aes(x=version, fill=ref)) +
    geom_boxplot(stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90)) +
    geom_hline(yintercept = ref_r2, linetype=2, alpha=0.5, ) + 
    facet_grid(variable~design, scales = "free_x", switch = "both") +
    scale_y_continuous(sec.axis = sec_axis(trans=~./ref_r2, name= NULL,# "Exposure Model R2 (% Difference)", 
                                           labels = scales::percent), position="right") +
    labs(x=NULL, y=NULL, fill=NULL)
}

# MSE-based R2
lapply(levels(refs1$variable), function(x) {r2_plot_multifacet(y_variable= "MSE_based_R2", facet_variable=x)}) %>%
  ggarrange(plotlist = ., ncol = 1, common.legend = T, legend = "bottom") %>%
  annotate_figure(left = "PNC Exposure Model R2 (% of Reference Model)",
                  right = "PNC Exposure Model R2",
                  bottom = "Design")

ggsave(file.path(image_path, "SI", "r2_sensitivity.png"), width = 12, height = 12)

# regression-based R2
lapply(levels(refs1$variable), function(x) {r2_plot_multifacet(y_variable= "reg_based_R2", facet_variable=x)}) %>%
  ggarrange(plotlist = ., ncol = 1, common.legend = T, legend = "bottom") %>%
  annotate_figure(left = "PNC Exposure Model R2 (% of Reference Model)",
                  right = "PNC Exposure Model R2",
                  bottom = "Design")

ggsave(file.path(image_path, "SI", "r2_reg_based_sensitivity.png"), width = 12, height = 12)

################################################################################
# SI - secondary analyses of NO2
y_variable <- "MSE_based_R2"
ref_r2 <- model_eval %>%
  filter(design=="All Data", 
         grepl("no2", model)) %>%
  select(variable, MSE_based_R2, reg_based_R2) %>%
  pull(get(y_variable))
  
model_eval %>%
  filter(grepl("no2", model),
         design != "All Data") %>%
    mutate(version = gsub("Bus", "Business", version),
            version = factor(version, levels= version_levels2)) %>% View()
  group_by(version, design, ref) %>%
  summary_table(var = y_variable) %>%
  ggplot(aes(x=version, fill=ref)) +
  geom_boxplot(stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90)) +
  geom_hline(yintercept = ref_r2, linetype=2, alpha=0.5, ) +
  facet_wrap(~design, scales = "free_x", switch = "x") + 
  geom_label(data=temp, aes(y=ref_r2, label=label), fill= "white",show.legend = F, size=3) +
  
  scale_y_continuous(sec.axis = sec_axis(trans=~./ref_r2, name="NO2 Exposure Model R2 (% of Reference Model)", labels = scales::percent), position="right") +
    
  labs(y = "NO2 Exposure Model R2", x = "Design", fill=NULL)

ggsave(file.path(image_path, "SI", "r2_secondary_no2.png"), width = 12, height = 12)

```

table of exposure model R2s relative to the reference R2

* i may have rounded thse to nearest 5% in the paper 

```{r}
model_eval %>%
  filter(grepl(main_pollutants_labels, variable)) %>%  
  mutate(ref_MSE_based_R2 = MSE_based_R2[grepl("_all_", model)],
         proportion_different = (MSE_based_R2-ref_MSE_based_R2)/-ref_MSE_based_R2,
         proportion = MSE_based_R2/ref_MSE_based_R2) %>% 
  group_by(design, version, variable) %>%
  summarize(
    n=n(),
    median_est = median(MSE_based_R2),
    median_percent_of_ref = median(proportion)*100,
    median_attenuation = median(proportion_different)*100,
  ) %>%
  kable(caption = "summary of each design's R2 as a proportion of the reference and difference", digits = 2) %>%
  kable_styling()


```


### poster
```{r}
# poster
# main analyses
model_eval %>%
  filter(variable %in% main_pollutants_labels,
         design != "All Data") %>%
    mutate(variable = ifelse(grepl("Total", variable), "10-420 nm (Primary)", as.character(variable)),
           variable = factor(variable, levels = c("10-420 nm (Primary)", "10-100 nm", "20-1,000 nm")),
           analysis = ifelse(grepl("10-420", variable), "Primary", "Sensitivity"),
           version = gsub("Bus", "Business", version),
           version = gsub("Adj", "\nTemporally\nAdjusted", version),
           #version = gsub(" ", "\n", version)
           version = factor(version, levels=version_levels2)
           ) %>%
  group_by(version, design, ref) %>%
  summary_table(var = "MSE_based_R2") %>%
  ggplot(aes(x=version, fill=ref)) +
  geom_boxplot(stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90), 
               #col="gray"
               ) +
  geom_hline(data=filter(refs1, grepl("10-420", variable)), aes(yintercept = MSE_based_R2), linetype=2, alpha=0.5, col=uw_purple) + 
  facet_wrap(~design, scales = "free_x", switch = "x") +
  geom_label(data=temp, aes(y=est+0.02, label=label), fill= "white", col=uw_purple, show.legend = F, size=(label_size)) +
  poster_theme +
  scale_fill_manual(values = c(uw_spirit_gold, uw_husky_gold)) +
  ylim(0, 0.7) +
  labs(y = "Exposure Model R2", x = "Design", fill=NULL)
  
ggsave(file.path(image_path, "other", "presentation", "r2_large_text.png"), width = 13, height = 9)


```


### temporally adjusted designs

compare 2 min NO2 vs UFP (for temporal adjustmnet)

```{r}
compare_1hr_avgs <- stops_w %>%
  drop_na(ns_total_conc, no2) %>%
  group_by(date, hour) %>%
  summarize(no_2min_visits=n(),
            no2 = mean(no2),
            ns_total_conc = mean(ns_total_conc)
            )

# 1387 hour avg paired readings     #8671 2 min pars
nrow(compare_1hr_avgs)
# R=0.64 
cor(compare_1hr_avgs$ns_total_conc, compare_1hr_avgs$no2, method="pearson")
 
```


scatterplot of paired unadjusted & temporally adjusted campaign R2

```{r}

print(paste0("dotted lines are +-", one_to_one_band*100, "%"))

model_eval %>%
  filter(design == "Fewer Hours",
         variable == main_pollutants_labels) %>%
  select(-c(model, RMSE, reg_based_R2, version_code)) %>% 
  mutate(adjusted = ifelse(grepl("Adj", version, ignore.case=T), "Adjusted", "Unadjusted"),
         version = gsub(" Adj", "", version),
         version = gsub("Bus", "Business", version),
         version = paste(version, "Hours")
         ) %>%   
  pivot_wider(names_from = adjusted, values_from = MSE_based_R2) %>%  
  mutate(performance = ifelse(Adjusted > Unadjusted, "R2 Improved", "R2 Not Improved")) %>%
  
  ggplot(aes(x=Unadjusted, y=Adjusted,)) + 
  facet_wrap(~version, switch="x") +
  geom_abline(slope = c(1), intercept = 0, linetype=2, alpha=0.5) +
  geom_abline(slope = c(1-one_to_one_band, 1+one_to_one_band), intercept = 0, linetype=3, alpha=0.25) +
  geom_smooth(method = "lm") +
  geom_point(aes(col=performance)) +
  #make x y equal size
  theme(aspect.ratio = 1) +
  geom_label(x=Inf, y=Inf, label="1-1", vjust=1, hjust=1, show.legend = F, col="black") +
  labs(shape="Fewer Hours Design", 
       col = "Impact of Temporal Adjustment",
       x = "Exposure Model R2 for\nTemporally Unadjusted Campaign",
       y = "Exposure Model R2 for\nTemporally Adjusted Campaign"
       #x = "Unadjusted Campaign R2",
       #y = "Temporally Adjusted Campaign R2"
       )
  
ggsave(file.path(image_path, "SI", "r2_temp_adj.png"), width = 6, height = 4)

```

compare predictions from unadjusted & adjusted campaigns to observations. does the error increase?

•	E.g. is it lower for unadjusted ~ 75% of the time; •	We want to know for site A, are all/most campaigns made worse 



```{r, eval=T}

predictions %>%
  filter(design == "Fewer Hours") %>%
  group_by(version, adjusted) %>%
  summarize(
    N = n(),
    Min = min(error),
    #Q2.5 = quantile(error, 0.025),
    Q25 = quantile(error, 0.25),
    Q50 = quantile(error, 0.50),
    Q75 = quantile(error, 0.75),
    #Q97.5 = quantile(error, 0.975),
    Max = max(error),
    #IQR = Q75-Q25,
    #range = Max-Min
    ) %>%
  kable(caption = "Distribution of prediction error (prediction - gs_estimate). N=309 sites x 30 campaigns", digits = 0) %>%
  kable_styling()

# arrange sites by concentration & variability
#sample_sites <- sample(unique(other_design_site_predictions$location), size = 50)
# select 10 random sites from each concentration decile (low to high conc sites)
temp <- predictions %>%
  filter(variable == main_pollutants_labels,
         design == "Fewer Hours") %>%
  
  distinct(location, gs_estimate) %>%
  arrange(gs_estimate) %>%
  mutate(concentration_rank = row_number(),
         concentration_rank_group = cut_number(concentration_rank, n=10)) 
# 5 ranodm samples per decile
set.seed(5)
sample_sites <- temp %>%
  group_by(concentration_rank_group) %>%
  slice_sample(n=5) 
  

print(paste("Prediction site errors from", nrow(sample_sites), "random sites. Sites are arranged by site concentration (all-data estimate), with low concentration sites near the bottom."))
#other_design_site_predictions %>%
predictions %>%
  filter(#design == "Fewer Hours",
         grepl("nstot_fewhrs", model)) %>%  
  
  filter(location %in% sample_sites$location) %>%
  mutate(location = factor(location, levels=temp$location),
         
         version = gsub(" Adj", "", version),
         version = gsub("Bus", "Business", version),
         version = paste(version, "Hours")
         ) %>% 
  
  group_by(version, location, adjusted) %>%
  summary_table(var = "error") %>% 
  ggplot(aes(y=location, fill=adjusted)) +
  geom_boxplot(stat="identity", aes(xmin=Q10, xlower=Q25, xmiddle=Q50, xupper=Q75, xmax=Q90)) +
  facet_wrap(~version) +
  geom_vline(xintercept = 0, linetype=2) +
  labs(x="Prediction Error (pt/cm3)",
       fill = "Temporally")
 
ggsave(file.path(image_path, "SI", "temp_adj_site_error_boxplots.png"), width = 7, height = 9)


```





```{r, eval=F}
### poster

# this was for an older version that didn't include e.g. site type or temporal adj
model_eval %>%
  filter(variable %in% main_pollutants_labels,) %>%
  ggplot(aes(x=version, y=MSE_based_R2)) + 
  geom_hline(data=select(filter(t2, design=="All Data"), variable, Q50), aes(yintercept = Q50), linetype=2, alpha=0.5) + 
  geom_boxplot(fill=uw_gold1, col=uw_purple)+
  facet_grid(~design, scales = "free", switch = "both") +
  labs(y = "Exposure Model R2", x = "Design")

ggsave(file.path(image_path, "other", "poster", "exposure r2.png"), width = 4.5, height = 2.5)

```

## Participant Exposures

N_predictions = 65400 participant predictions = 30 campaigns * 2128 participants/campaign

```{r}
t1 <- cs %>%
  filter(variable %in% #main_pollutants_labels
           c(as.character(main_pollutants_labels), c("ns_total_conc"))
           ) %>%
  group_by(variable, design, version) %>%
  
  # --> TEMP B/C MISSING some versions
  drop_na(exposure) %>%
  
  #alt_boxplot(var = "exposure")  
  summarize(
      N = n(),
      Min = min(exposure),
      Q2.5 = quantile(exposure, 0.025),
      Q25 = quantile(exposure, 0.25),
      Q50 = quantile(exposure, 0.50),
      Q75 = quantile(exposure, 0.75),
      Q97.5 = quantile(exposure, 0.975),
      Max = max(exposure),
      IQR = Q75-Q25,
      range = Max-Min
    )

t1 %>%
  kable(caption = "Predicted exposures by design", 
        digits = 0, #format.args = list(big.mark  = ",")
        ) %>%
  kable_styling()

```

```{r}
# alt to above: scatterplots
ref <- cs %>%
  filter(grepl("All Data", design),
         variable %in% sensitivity_pollutant_labels) %>%
  select(study_id, all_exposure = exposure, all_model = model, variable)

samples <- cs %>%
  filter(!grepl("All Data", design),
         variable %in% sensitivity_pollutant_labels,
         #only show some examples
         version %in% version_examples
         ) %>%
  select(study_id, exposure,  model, variable, design, version, campaign)

comp_exp <- left_join(ref, samples)
# x=sensitivity_pollutant_labels[3]
lapply(sensitivity_pollutant_labels, function(x) {
  
  p <- comp_exp %>%
  filter(variable== x) %>%
    ggplot(aes(x=all_exposure, y=exposure, col=campaign, group=campaign)) +
    facet_wrap_equal(~design+version, ncol=4) + 
    geom_smooth(se = F, size=0.25, alpha=0.4) + 
    geom_smooth(se = F, inherit.aes = F, aes(x=all_exposure, y=exposure), col="black") + 
    geom_abline(slope = 1, intercept = 0, linetype=2, alpha=0.5) +
    geom_abline(slope = 1.25, intercept = 0, linetype=3, alpha=0.3) + 
    geom_abline(slope = 0.75, intercept = 0, linetype=3, alpha=0.3) + 
    #make x y equal size  
    theme(aspect.ratio = 1) +
    
    labs(x = "All Data Exposure Prediction", 
         y= "Sampling Design Exposure Prediction", 
         title = x,
         col="Campaign")

  if(grepl("Total|10-420", x)) {
    p <- p + labs(title = "10-420 nm (Primary)")
    print(p)
    ggsave(file.path(image_path, "SI", paste0("predicted_exposure_",x ,".png")), width = 9, height = 7)
    } else{
      p <- p + labs(title = x)
      print(p)
      ggsave(file.path(image_path, "SI", paste0("predicted_exposure_",x ,".png")), width = 11, height = 7)
    }

})


```

comparison of exposures from the issue 12 model to the all-data HEI model

```{r}
bound0 <- 0.1
print(paste0("NanoScan reference models. dashed line is 1-1 and +-", bound0*100, "%"))
cs %>%
  filter(model == "s_nstot_all_01") %>%
  ggplot(aes(x=exposure, y=cum_exp_ufp_10_42_MM_05_yr)) + 
  geom_point(alpha=0.1) + 
  geom_smooth() +
  geom_abline(slope = 1, intercept = 0, linetype=2, alpha=0.5) +
  geom_abline(slope = c(1+bound0, 1-bound0), intercept = 0, linetype=3, alpha=0.3) + 
  #make x y equal size  
  theme(aspect.ratio = 1) +
  labs(x="s_nstot_all_01", 
       caption = paste0("dashed line is 1-1 and +-", bound0*100, "%"))

ggsave(file.path(image_path, "other", "qc", "all_data_ns_vs_issue12_model.png"), width = 6, height = 6)

print(paste0("P-TRAK reference models. dashed line is 1-1 and +-", bound0*100, "%"))
cs %>%
  filter(model == "s_pncnoscreen_all_01") %>%
  ggplot(aes(x=exposure, y=cum_exp_ufp_20_1k_MM_05_yr)) + 
  geom_point(alpha=0.1) + 
  geom_smooth() +
  geom_abline(slope = 1, intercept = 0, linetype=2, alpha=0.5) +
  geom_abline(slope = c(1+bound0, 1-bound0), intercept = 0, linetype=3, alpha=0.3) + 
  #make x y equal size  
  theme(aspect.ratio = 1) +
  labs(x="s_pncnoscreen_all_01",
       caption = paste0("dashed line is 1-1 and +-", bound0*100, "%"))
ggsave(file.path(image_path, "other", "qc", "all_data_ns_ptrak_issue12_model.png"), width = 6, height = 6)

```

## Predicted Exposure 'Error'

5/30/24. decided not to do this b/c to look at this, we need to sho this is true after adjusting for potential confoundres

```{r, eval=F}
cs_ref <- cs %>%
  filter(variable %in% main_pollutants_labels,
         design == "All Data") %>%
  select(study_id, casi_irt, all_data_exposure = exposure)

mean_casi <- mean(cs_ref$casi_irt)

prediction_comparison0 <- cs %>%
  filter(variable %in% main_pollutants_labels,
         design != "All Data",
         #drop some of these
         !version %in% c("H4 L20", "H6 L18", "H8 L16", "H10 L14", "H14 L10", "H16 L8", "H18 L6", "H20 L4")) %>%
  left_join(cs_ref, by= c("study_id", "casi_irt")) %>%
  mutate(prediction_diff = exposure - all_data_exposure,
         prediction_diff_abs = abs(exposure - all_data_exposure))  

# calculate avg prediction diff between designs
prediction_comparison <- prediction_comparison0 %>%
  group_by(study_id, casi_irt, variable, design, version) %>%
  summarize(
    n=n(),
    # exposure=median(exposure),
    # #exposure=mean(exposure)
    
    # prediction_diff = mean(prediction_diff),
    # prediction_diff_abs = mean(prediction_diff_abs),
    prediction_diff = median(prediction_diff),
    prediction_diff_abs = median(prediction_diff_abs),
    prediction_sd = sd(exposure)
    )  %>%
  
  # --> TEMP. shoudn't need to do this later
  drop_na(casi_irt)



print("predicted exposure difference for each campaign and study_id vs CASI-IRT. thin transparant lines are lm fits for each campaign") 
print("no strong evidence that exposure assessment error is differentially distributed across CASI-IRT")

# exposure on x-axis 
# x=design_labels[3]
lapply(design_labels, function(x) {
  
  # #prediction_comparison %>%
  # prediction_comparison0 %>%
  #   filter(design == x) %>%  
  # 
  #   ggplot(aes(x=casi_irt, y=prediction_diff,
  #              col=version
  #              )) + 
  #   facet_wrap(~design) + 
  #   geom_point(alpha=0.01, size=0.5) +
  #   #geom_bin2d(alpha=0.3) +
  #   #geom_vline(xintercept = mean_casi, linetype=2, alpha=0.5) +
  #   stat_smooth(aes(group=interaction(campaign, version)), 
  #                   geom='line', method = "lm", se=F, alpha=0.4) +
  #   stat_smooth(geom='line', method = "lm", se=F, size=2) +
  #   geom_hline(yintercept =0, linetype=2, alpha=0.5) +
  # 
  #   ylim(min(prediction_comparison0$prediction_diff), max(prediction_comparison0$prediction_diff)) +
  #   scale_fill_continuous(type = "viridis") +
  #   labs(x=NULL, y=NULL)
  
  prediction_comparison0 %>%
    filter(design == x) %>%  

    ggplot(aes(y=casi_irt, x=prediction_diff, col=version )) + 
    facet_wrap(~design) + 
    #geom_point(alpha=0.01, size=0.5) +
    stat_smooth(aes(group=interaction(campaign, version)),
                    geom='line', #method = "lm", 
                se=F, alpha=0.4) +
    stat_smooth(geom='line', #method = "lm", 
                se=F, size=1.5) +
    geom_hline(yintercept = mean_casi, linetype=2, alpha=0.3) +
    geom_vline(xintercept =0, linetype=2, alpha=0.3) +

    xlim(min(prediction_comparison0$prediction_diff), max(prediction_comparison0$prediction_diff)) +
    ylim(min(prediction_comparison0$casi_irt), max(prediction_comparison0$casi_irt)) +
    scale_fill_continuous(type = "viridis") +
    labs(x=NULL, y=NULL)
  
  
  }) %>%
  ggarrange(plotlist = ., align = "hv") %>%
  annotate_figure(
    bottom = "Difference in Predicted PNC Exposure Relative to the All-Data Campaign",
    left = "Participant Baseline CASI-IRT")

ggsave(file.path(image_path, "SI", "measurement_error_by_casi.png"), width = 8, height = 8)






##########################################################################################
# CASI on x-axis 

lapply(design_labels, function(x) {
prediction_comparison0 %>%
    filter(design == x) %>%  

    ggplot(aes(x=casi_irt, y=prediction_diff, col=version )) + 
    facet_wrap(~design) + 
    #geom_point(alpha=0.01, size=0.5) +
    stat_smooth(aes(group=interaction(campaign, version)), geom='line', 
                method = "lm", 
                se=F, alpha=0.1) +
    stat_smooth(geom='line', method = "lm", 
                se=F, size=1.5) +
    #geom_vline(xintercept = mean_casi, linetype=2, alpha=0.3) +
    geom_hline(yintercept =0, linetype=2, alpha=0.3) +

    ylim(-2e3, 2e3) +
    xlim(min(prediction_comparison0$casi_irt), max(prediction_comparison0$casi_irt)) +
    scale_fill_continuous(type = "viridis") +
    labs(x=NULL, y=NULL)
  
  
  }) %>%
  ggarrange(plotlist = ., align = "hv") %>%
  annotate_figure(
    left = "Difference in Predicted PNC Exposure Relative to the All-Data Campaign",
    bottom = "Participant Baseline CASI-IRT")

ggsave(file.path(image_path, "SI", "measurement_error_by_casi_switch_axes.png"), width = 8, height = 8)
##########################################################################################

# --> scatterplot: x axis: predictions all data; y=variability or SD or bias

lapply(design_labels, function(x) {
  
  prediction_comparison %>%
    filter(design == x) %>%

    ggplot(aes(x=casi_irt, col=version, y=prediction_sd)) + 
    facet_wrap(~design) + 
    geom_point(alpha=0.03, size=0.5) + 
    #geom_bin2d(alpha=0.3) +
    geom_hline(yintercept =0, linetype=2, alpha=0.5) +
    #geom_vline(xintercept = mean_casi, linetype=2, alpha=0.5) +
    geom_smooth(#method = "lm"
                ) + 
    ylim(min(prediction_comparison$prediction_sd), max(prediction_comparison$prediction_sd)) +
    scale_fill_continuous(type = "viridis") +
    labs(x=NULL, y=NULL)
  
  }) %>%
  ggarrange(plotlist = ., align = "hv") #%>%
  annotate_figure(left = "SD of predicted UFP for participants (SD is from n=30 campaign predictions)",
                  bottom = "Participant Baseline CASI-IRT")

ggsave(file.path(image_path, "SI", "prediction_SD_by_casi.png"), width = 8, height = 8)

```




## Prediction Correlations

```{r}
full <- cs %>% 
  filter(grepl("All Data", design),
         variable %in% sensitivity_pollutant_labels) %>%
  select(study_id, variable, exposure, model) %>%
  rename(full_prediction = exposure)

designs <- filter(cs, 
                  variable %in% sensitivity_pollutant_labels,
                  !model %in% unique(full$model),
                  #drop some of these
                  !version %in% c("H4 L20", "H8 L16", "H10 L14", "H14 L10", "H16 L8", "H20 L4")) %>%
  select(study_id, variable, exposure, model, design, version, campaign) %>%
  rename(design_prediction = exposure)

comp <- left_join(select(full, -model), designs)

```

correlations (N= 30 correlations for each design-version)

```{r}
corr_table <- comp %>%
  group_by(model, variable, design, version, campaign) %>%
  summarize(n=n(),
            r = cor(full_prediction, design_prediction))  %>%
  ungroup() %>%
  mutate(
    ref = ifelse((design == "Fewer Visits" & version == "12") |
                   (design == "Fewer Seasons" & version == "4") |
                   (design == "Unbalanced Visits" & version == "H12 L12"), "Balanced/More Data", "Unbalanced/Less Data"))  

corr_table %>%
  group_by(variable, design, version) %>%
  alt_boxplot(var = "r", min_q=bp_min, max_q=bp_max) %>%
  
  kable(caption = "Distribution of Pearson correlations (R) between full campaign and sampling design predictions (N= 30 correlations for each design-version)", 
        digits = 2) %>%
  kable_styling()

# corr_table %>%
#   filter(variable %in% main_pollutants_labels) %>% 
#   ggplot(aes(x=version, y=r, fill=ref)) +
#   geom_boxplot()+
#   facet_grid(~design, scales = "free", switch="both") + 
#   facet_wrap(~design, scales = "free", switch="x") + 
#   labs(y = "Correlation (R)", x = "Design", fill=NULL)
# 
# #ggsave(file.path(image_path, "prediction_correlations.png"), width = 8, height = 6)

#SI
# --> CHECK THAT THIS LOOKS CORRECT IN UPDATE (HAS TEMP ADJ?)
corr_table %>%
  mutate(variable = ifelse(grepl("Total", variable), "10-420 nm (Primary)", as.character(variable)),
           variable = factor(variable, levels = c("10-420 nm (Primary)", "10-100 nm", "20-1,000 nm")),
           analysis = ifelse(grepl("10-420", variable), "Primary", "Sensitivity"),
         
         version = gsub("Bus", "Business", version),
         version = gsub(" Adj 1", " \nTemporally\nAdjusted", version),
         version = factor(version, levels= version_levels2)
         ) %>%
  
  group_by(version, design, variable, ref) %>%
  summary_table(var = "r") %>%  
  ggplot(aes(x=version, fill=ref)) +
  geom_boxplot(stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90)) +
  facet_grid(variable~design, scales = "free_x", switch="both") + 
  labs(y = "Correlation (R)", x = "Design", col="Analysis", fill=NULL) #+ scale_x_discrete(guide = guide_axis(n.dodge=2))

ggsave(file.path(image_path, "SI", "prediction_correlations2.png"), width = 12, height = 10)

```

# --> ? NO2: add correlation plot for no2? 

```{r}


```


### poster

```{r, eval=F}
corr_table %>%
  ggplot(aes(x=version, y=r )) +
  geom_boxplot(fill=uw_gold1, col=uw_purple)+
  facet_grid(~design, scales = "free", switch="both") + 
  labs(y = "Correlation (R)",
       x = "Design")

ggsave(file.path(image_path, "other", "poster", "prediction_correlations.png"), width = 12, height = 3)
```


# CASI


```{r}
# person-level dataset
pop <- cs %>%
  filter(variable %in% main_pollutants_labels,
         design== "All Data") %>% 
  group_by(variable) %>%
  mutate(#high_exposure = exposure > median(exposure),
         exposure_group = ifelse(exposure <= quantile(exposure, 0.33), "Low PNC",
                                 ifelse(exposure > quantile(exposure, 0.33) & exposure < quantile(exposure, 0.66), "Medium PNC",
                                        ifelse(exposure >= quantile(exposure, 0.66), "High PNC", NA))),
         exposure_group = factor(exposure_group, levels = c("Low PNC", "Medium PNC", "High PNC")), 
         visit_age = visit_age_centered75+75
         ) %>% 
  distinct(study_id, casi_irt, visit_age, year2, #apoe, 
           male, degree, 
           #race_white, 
           variable, exposure, #high_exposure, 
           exposure_group) #%>% pivot_wider(names_from = variable, values_from = c(exposure_group, exposure))  

names(pop) <- gsub("\\ .*|\\,.*", "", names(pop))

pop %>%
  alt_boxplot(var="casi_irt") %>%
  kable(caption = "Distribution of CASI-IRT", 
        digits = 2) %>%
  kable_styling()

```


# Table 1

```{r}
# Table1 tutorials: 
## https://cran.r-project.org/web/packages/table1/table1.pdf 
## https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html
 
# my.render.cont <- function(x) {
#     with(stats.apply.rounding(stats.default(x), digits=0), c("",
#         "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
# }
# my.render.cat <- function(x) {
#     c("", sapply(stats.default(x), function(y) with(y,
#         sprintf("%d (%0.0f %%)", FREQ, PCT))))
# }

# table labels
t1_labels <- list(
  labels = list(
    casi_irt = "CASI-IRT",
    visit_age = "Visit Age",
    year2 = "Calendar Year (2 yr Cat)",
    apoe = "APOE e4 Allele",
    male = "Sex",
    degree = "Degree",
    #race_white = "Race",
    variable = "Pollutant",
    #apoe_available = "Included in Main Analysis",
    #model_wt = "IPW for Modeling Cohort",
    #high_exposure_PNC = "High PNC Exposure  (>Median)",
    exposure_group = "PNC Exposure (pt/cm3)",
    exposure = "Residential PNC (pt/cm3) Exposure"
    ),
  units = list(
    visit_age = "Years"
     ),
  categoricals = list(
    apoe = list('1' = "Carriers",
                '0' = "Non-Carriers"),
    # apoe_available = list('TRUE' = "Included in Main Analysis",
    #                       'FALSE' = "Not Included in Main Analysis"),
    male = list('1' = "Male",
                '0' = "Female"),
     
        degree = list('0' = "None",
                  '1' = "GED/High School",
                  '3' = "Bachelor's",
                  '4' = "Master's",
                  '5' = "Doctorate",
                  '6' = "Other" #, digits.pct=0
                  ),
    # race_white = list('1' = "White",
    #                   '0' = "People of Color"),

    # income_cat = list('1' = "<$35,000",
    #                   '2' = "$35,000 - <$50,000",
    #                   '3' = "$50,000 - <$75,000",
    #                   '4' = ">$75,000"),
    
    high_exposure_PNC = list('FALSE' = "PNC Below Median",
                                   'TRUE' = "PNC Above Median")
    ) 
  ) 

print("Baseline cohort characteristics stratified by whether 5-year PNC exposure at baseline was below or above the median.")
# Main Table 1
t1read(pop, t1_labels#, render.continuous.default = my.render.cont
         ) %>%
  table1(~ visit_age + male + degree + casi_irt + exposure | exposure_group, data=.)

```

# Health Model Results

```{r}
rectangle_alpha <- 0.15

```


## Beta Estimates 

as a reference, these are the health effect estimates from issue 12. The models are developed slightly different (e.g., have 3 vs 2 PLS components; ~1 extra modeling covariate is available; all available visit data are used in the models rather than conditioning on availability of NS readings)

```{r}
model_coefs_issue12 %>%
  kable(caption = "issue 12 health effect estimates for NS and P-TRAK models", digits=3) %>%
  kable_styling()
```

### paper

The black horizontal line and gray area are the health effect estimate from the full campaign

```{r, fig.height=8, fig.width=8}
get_reference_betas <- function(dt) {
  dt %>%
  filter(design == "All Data",
         (variable %in% sensitivity_pollutant_labels | grepl("no2", variable, ignore.case=T))
           ) %>%
  select(variable, est, lower, upper, se, significant) %>%
   mutate(variable2 = variable,
          variable = ifelse(grepl("Total", variable), "10-420 nm", as.character(variable)),
           variable = factor(variable, levels = c("10-420 nm", "10-100 nm", "20-1,000 nm", "NO2 (ppb)")),
           analysis = ifelse(grepl("10-420", variable), "Primary", "Sensitivity"),
          
          ) 
  }

true_betas <- get_reference_betas(model_coefs)
true_betas_sensitivity <- get_reference_betas(model_coefs_sensitivity)
 
true_betas %>%
  select(-variable2) %>%
  mutate_if(is.numeric, ~round(., 3)) %>%
  kable(caption = "coefficient health estiamtes from the all data campaign") %>%
  kable_styling()

true_betas_sensitivity %>%
  select(-variable2) %>%
  mutate_if(is.numeric, ~round(., 3)) %>%
  kable(caption = "coefficient health estiamtes from the all data campaign") %>%
  kable_styling()


p_list <- unique(true_betas$variable) %>% setdiff("NO2 (ppb)")# %>% as.character()
# x = p_list[2]
lapply(p_list, function(x){ 
    
      p <- model_coefs %>%
        mutate(variable = ifelse(grepl("Total", variable, ignore.case=T), "10-420 nm", as.character(variable)),
           variable = factor(variable, levels = c("10-420 nm", "10-100 nm", "20-1,000 nm")),
           analysis = ifelse(grepl("10-420", variable), "Primary", "Sensitivity"),
           adjusted = ifelse(grepl("adj", model, ignore.case=T), "Temporally Adjusted", "Unadjusted"),
           adjusted = factor(adjusted, levels = c("Unadjusted", "Temporally Adjusted")),
           version = gsub(" Adj| Adj 1", "", version),
           significant = ifelse(significant==TRUE, "Stat. Sign.", "Not Stat. Sign.")
           ) %>% 
        filter(variable == x,
             design != "All Data",
             version %in% version_examples) %>% 
        
        ggplot(aes(x=campaign, col=significant, shape=adjusted)) +
        geom_hline(yintercept = 0, linetype=2, alpha=0.2) +
      geom_rect(inherit.aes = F, data=filter(true_betas, variable==x), aes(ymin = lower, ymax = upper, xmin=-Inf, xmax=Inf), alpha=rectangle_alpha) +
      geom_hline(data=filter(true_betas, variable==x), aes(yintercept = est)) +
      geom_pointrange(aes(y=est, ymin=lower, ymax=upper), size=0.4, 
                      position=position_dodge(width=0.7)) +
      scale_x_continuous(breaks = c(1, seq(10,30,10))) +
      labs(x="Campaign", y = "Health Estimate (95% CI)", shape=NULL, col=NULL)
    
        p <- p + facet_wrap(~design+version, ncol = 2) 
        
        if(!grepl("10-420 nm", x)){p <- p + labs(title=x)}
        
        print(p)
        
        ggsave(file.path(image_path, "SI", paste0("beta_", x, ".png")), width = 12, height = 8)
      })

```

proportion of campaigns showing "significant" results 

```{r}
model_coefs %>%
  #filter(grepl("Total", variable)) %>%
  group_by(design, version, variable) %>%
  summarize(n=n(),
            proportion_of_campaigns_significant = mean(significant)) %>%
  arrange(-proportion_of_campaigns_significant) %>%
  kable(caption = "proportion of 'significant' estimates from campaigns. Main results w/ models not fully adjusted",
        digits = 2) %>%
  kable_styling()

model_coefs_sensitivity %>% 
  group_by(design, version, variable) %>%
    summarize(n=n(),
              proportion_of_campaigns_significant = mean(significant)) %>%
    arrange(-proportion_of_campaigns_significant) %>%
  kable(caption = "proportion of 'significant' estimates from campaigns. Sensitivity results w/ models extensively adjusted",
        digits = 2) %>%
  kable_styling()


```

```{r}
d <- c("All", "Visits", "Seasons", "Hours")

```

### for ppt
same as above for presentation

```{r, eva=F}

p <- lapply(d, function(x) {
  p <- model_coefs %>%
      filter(grepl("Total", variable),
             grepl(x, design)) %>%
    
      ggplot(aes(x=campaign, col=significant)) +  
      facet_grid(design~version, scales="free_x", switch = "both") + 
      geom_hline(yintercept = 0, linetype=2, alpha=0.2) +
      geom_rect(inherit.aes = F, data=filter(true_betas, grepl("Total", variable)), 
                aes(ymin = lower, ymax = upper, xmin=-Inf, xmax=Inf), alpha=0.25) +
      geom_hline(data=filter(true_betas, grepl("Total", variable)), 
                 aes(yintercept = est)) +
      geom_pointrange(aes(y=est, ymin=lower, ymax=upper), size=0.5, alpha=0.8) +
      labs(col = "Statistically Significant", x="Campaign", y = "Coefficient Estimate (95% CI)")
  
  print(p)

  ggsave(file.path(image_path, "other", "presentation", paste0("beta ", x, ".png")), width = 6, height = 4)

})

```

### poster


```{r, eva=F}
#--> update

model_coefs %>%
    filter(grepl("Total", variable),
           (design %in% c("Fewer Hours", "All Data") |
              (design == "Fewer Visits" & version=="12")
              )
           ) %>%
  mutate(significant = ifelse(significant==TRUE, "Stat. Sign.", "Not Stat. Sign."),
         significant = factor(significant, levels = c("Stat. Sign.", "Not Stat. Sign."))
         ) %>%
  
    ggplot(aes(x=campaign, col=significant)) +  
    facet_wrap(~design+version, scales="free_x",  #switch = "x"
               ) + 
    #facet_grid(design~version, scales="free", switch = "both", ) + 
    geom_hline(yintercept = 0, linetype=2, alpha=0.3) +
    geom_rect(inherit.aes = F, data=filter(true_betas, grepl("Primary", analysis)), 
              aes(ymin = lower, ymax = upper, xmin=-Inf, xmax=Inf), alpha=0.25) +
    geom_hline(data=filter(true_betas, grepl("Primary", analysis)), 
               aes(yintercept = est)) +
    geom_pointrange(aes(y=est, ymin=lower, ymax=upper), size=0.15, 
                    #alpha=0.8
                    ) +
  theme(axis.text.x = element_blank(),
       axis.ticks.x=element_blank()) +
  
  scale_color_manual(values = c(uw_purple, uw_gold1)) +
  
    labs(col = "", #"Statistically Significant",
         x="Campaign (1-30)",
         y = "Health Effect Estimate")
  

ggsave(file.path(image_path, "other", "poster", paste0("betas.png")), width = 6, height = 5.5)
  
```

## Beta Summary

```{r}
# keep this even though code below is the same to not show facet label for main analysis figure
# true Coefficient estimate
tot_pnc <- filter(true_betas, grepl("Total|10-420", variable)) %>%
  pull(est)
tot_pnc_sensitivity <- filter(true_betas_sensitivity, grepl("Total|10-420", variable)) %>%
  pull(est)

y_lims <- c(-0.018, 0.0005)

# model_coefs %>%
#   filter(grepl("Visits|Seasons", design)) %>%
#   group_by(variable) %>%
#   alt_boxplot(var = "est") %>%
#   kable(caption = "distribution of Coefficient estimates for fewer visits & seasons", digits = 3) %>%
#   kable_styling()

# % attenuation (e.g., reported in abstract)
model_coefs %>%
  filter(grepl(main_pollutants_labels, variable)) %>% 
  mutate(ref_est = est[grepl("_all_", model)],
         proportion_different = (est-ref_est)/-ref_est,
         proportion = est/ref_est) %>% 
  group_by(design, version, variable) %>%
  summarize(
    n=n(),
    median_est = median(est),
    median_percent_of_ref = median(proportion)*100,
    median_attenuation = median(proportion_different)*100,
  ) %>%
  kable(caption = "summary of each design's beta as a proportion of the reference and difference", digits = 2) %>%
  kable_styling()
  
####################################################################################
# plots 

# for individual pollutants
beta_summary_plot <- function(dt, true_betas., variable.="Total|10-420") {
  true_betas. <- filter(true_betas., grepl(variable., variable)) %>%
    mutate(design="All Data",
           design= factor(design, levels= levels(model_coefs$design)),
           significant = ifelse(significant==TRUE, "Statistically Significant", "Not Statistically Significant"))
    
  p <- dt %>%
  filter(grepl(variable., variable)) %>% 
  mutate(version = gsub("Bus", "Business", version),
         version = gsub("Adj 1", "\nTemporally\nAdjusted", version),
         version = factor(version, levels=version_levels2)) %>%
  
  group_by(version, design, variable, ref) %>%
  summary_table(var = "est") %>%
  ggplot(aes(x=version, fill=ref)) +
  geom_boxplot(stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90)) +
  facet_wrap(~design, scales="free_x", switch="x") +
  geom_hline(yintercept = true_betas.$est, linetype=1, alpha=0.5) +
  geom_hline(yintercept = 0, linetype=2, alpha=0.2) +
  scale_y_continuous(sec.axis = sec_axis(trans=~(.-true_betas.$est)/-true_betas.$est, name="Health Point Estimate (% Different from Reference)", labels = scales::percent),
                     position="right") +
  # scale_y_continuous(sec.axis = sec_axis(trans=~./true_betas.$est, name="Health Point Estimate (% of Reference Model)", labels = scales::percent),
  #                      position="right") +
    
    geom_label(inherit.aes = F, data=true_betas., aes(x=1, y=est, label = round(est, 3))) +
    labs(y = "Health Point Estimate", x = "Design",
       fill= NULL)
  
  if(grepl("Not", true_betas.$significant,ignore.case = T)){
    p <- p + geom_text(inherit.aes = F, data=true_betas., aes(x=1, y=est*2, label=significant)) 
  }
  
  # # # make the % label the correct direction of estimate happens to be positive
  # if(true_betas.$est>0){
  #   #p <- p + scale_y_continuous(breaks =breaks=c(-2,1, 4))
  #   }
    
  print(p)
  }

beta_summary_plot(dt=model_coefs, true_betas.=true_betas)
ggsave(file.path(image_path, "beta_boxplots_main.png"), width = 10, height = 6)

# SI - sensitivity
beta_summary_plot(dt=model_coefs_sensitivity, true_betas.=true_betas_sensitivity)
ggsave(file.path(image_path, "SI", "beta_boxplots_sensitivity.png"), width = 10, height = 6)

# SI - NO2
beta_summary_plot(dt=model_coefs, true_betas.=true_betas)




# SI - other PNC measures
# x=c("10-420 nm", "10-100 nm", "20-1,000 nm")[3]
lapply(c("10-420 nm", "10-100 nm", "20-1,000 nm"), function(x) {
  
  true_betas2 <- true_betas %>% 
    filter(grepl(x, variable)) %>%
    mutate(variable = ifelse(variable == "10-420 nm", "10-420 nm (Primary)", as.character(variable)),
           design="All Data",
           design= factor(design, levels= levels(model_coefs$design)))
 
  # for second axis
  ref_conc <- true_betas2$est 
 
  p <- model_coefs %>%
    
    mutate(variable = ifelse(grepl("Total", variable), "10-420 nm (Primary)", as.character(variable)),
           variable = factor(variable, levels = c("10-420 nm (Primary)", "10-100 nm", "20-1,000 nm")))  %>%
    filter(grepl(x, variable)) %>%
  
    group_by(version, design, variable, ref) %>%
    summary_table(var = "est") %>%
    ggplot(aes(x=version, fill=ref)) +
    geom_boxplot(stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90)) +
    
    facet_grid(variable~design, scales="free", switch="both", space="free") + 
    geom_hline(yintercept = ref_conc, linetype=1, alpha=0.5) +
    geom_hline(yintercept = 0, linetype=2, alpha=0.2) +
    scale_y_continuous(sec.axis = sec_axis(trans=~(.-ref_conc)/-ref_conc, name=NULL, labels = scales::percent), position="right") +
    #scale_y_continuous(sec.axis = sec_axis(trans=~./ref_conc, name=NULL, labels = scales::percent), position="right") +
    geom_label(inherit.aes = F, data=true_betas2, aes(x=1, y=est, label = round(est, 2))) +
  labs(y=NULL, #y = "Health Point Estimate", 
       x = "Design", fill=NULL)
  
  p
  }) %>%
  ggarrange(plotlist = ., ncol = 1, common.legend = T, legend = "bottom") %>%
  annotate_figure(left = "Health Point Estimate (% Different from Reference)", 
                  #left = "Health Point Estimate (% of Reference Model)",
                  right = "Health Point Estimate")
  
ggsave(file.path(image_path, "SI", "beta_boxplots.png"), width = 10, height = 10)


```

#--> no2: add beta plot: main & sensitivity health models

```{r}




```



### for ppt

```{r, eval=F}

# model_coefs %>%
#   filter(grepl("Total|10-420", variable)) %>%
#   
#   ggplot(aes(x=version, y=est)) +
#   facet_grid(~design, scales="free", switch="both", space="free") + 
#   geom_hline(data=filter(true_betas, grepl("Total", variable)),
#              aes(yintercept = est), linetype=1, alpha=0.5) +
#   geom_hline(yintercept = 0, linetype=2, alpha=0.2) +
#   geom_boxplot(fill=uw_gold1, col=uw_purple)+
#   scale_y_continuous(sec.axis = sec_axis(
#     trans=~(.-tot_pnc)/-tot_pnc, name="% Difference", labels = scales::percent)) +
#   geom_label(data=mutate(filter(true_betas, grepl("Total|10-420", variable)), design="All Data" ) %>% mutate(design= factor(design, levels= levels(model_coefs$design))), 
#                          aes(x=1, y=est, label = round(tot_pnc, 3)), col=uw_purple) +
#   labs(y = "Health Effect Estimate", x = "Design" )


#ggsave(file.path(image_path, "other", "presentation", "beta_summary.png"), width = 6, height = 4)

```

### for poster
```{r}
temp <- data.frame(version= 2.5, 
                   label = c("All-Data Reference", "No Association"),
                   est=c(tot_pnc, 0),
                   design = c("Fewer Hours")  
                    
                   ) %>%
  mutate(design = factor(design, levels = levels(model_coefs$design)))

model_coefs %>%
  filter(grepl("Total", variable),
         design != "All Data"
         ) %>%
  group_by(version, design, variable, ref) %>%
  summary_table(var = "est") %>%
  mutate(version = gsub("Bus", "Business", version),
         version = gsub("Adj", "\nTemporally\nAdjusted", version),
         version = factor(version, levels=version_levels2)) %>%
  ggplot(aes(x=version, fill=ref)) +
  geom_boxplot(stat="identity", aes(ymin=Q10, lower=Q25, middle=Q50, upper=Q75, ymax=Q90)) +
  facet_wrap(~design, scales="free_x", switch="x") +
  geom_hline(yintercept = tot_pnc, linetype=1, alpha=0.5, col=uw_purple) +
  geom_hline(yintercept = 0, linetype=2, alpha=0.2) +
  scale_y_continuous(sec.axis = sec_axis(trans=~(.-true_betas.$est)/-true_betas.$est, name="Health Point Estimate (% Different from Reference)", labels = scales::percent), position="right") +

  # scale_y_continuous(sec.axis = sec_axis(trans=~(.-tot_pnc)/-tot_pnc, name="Health Point Estimate\n% Difference", labels = scales::percent), position="right") +
    geom_label(data=temp, aes(y=est, label=label), fill= "white",show.legend = F, size=label_size) +
  geom_label(data=filter(temp, grepl("Reference", label, ignore.case = T)), aes(y=est, label=label), fill= "white",col=uw_purple, show.legend = F, size=label_size) +
  poster_theme +
  scale_fill_manual(values = c(uw_spirit_gold, uw_husky_gold)) +
  labs(y = "Health Point Estimate        ", x = "Design",
       fill= NULL)

ggsave(file.path(image_path, "other", "presentation", "beta_boxplots_main_large_text.png"), width = 15, height = 10)

```



```{r}
bias0 <- model_coefs %>%
  group_by(variable) %>%
  mutate(ref = est[design == "All Data"],
         error = est - ref,
         error_pct = round(error/abs(ref)*100, 1)) %>%
  filter(design != "All Data",
         variable %in% main_pollutants_labels) 


bias <- bias0 %>%
  group_by(variable, design, version) %>%
  alt_boxplot(var = "error") 

bias %>% 
  kable(caption = "Distribution of coefficient difference for each design", 
        digits = 3) %>%
  kable_styling()

#######################################
bias0 %>%
  filter(grepl("Visits|Seasons", design)) %>%
  alt_boxplot(var = "error") %>%
  mutate_if(is.numeric, ~round(., 3)) %>% 
  kable(caption = "Distribution of Coefficient errors for fewer visits & seasons") %>%
  kable_styling()

bias0 %>%
  filter(grepl("Fewer Hours", design)) %>%
  alt_boxplot(var = "error") %>%
  mutate_if(is.numeric, ~round(.,3)) %>%
  kable(caption = "Distribution of Coefficient differences for fewer hours") %>%
  kable_styling()

```


Percent error in the estimated betas (n=30 campaign models for each design-version)

```{r}

bias_pct <- bias0 %>%
  group_by(variable, design, version) %>%
  alt_boxplot(var = "error_pct") 

bias_pct %>% 
  #select(-c(Qmin, Qmax)) %>%
  mutate_if(is.numeric, ~round(.)) %>%
  kable(caption = "Distribution of Coefficient difference (%) for each design") %>%
  kable_styling()


#######################################
bias0 %>%
  filter(grepl("Visits|Seasons", design)) %>%
  alt_boxplot(var = "error_pct") %>%
  mutate_if(is.numeric, ~round(.)) %>%
  kable(caption = "Distribution of Coefficient difference (%) for fewer visits & seasons") %>%
  kable_styling()

bias0 %>%
  filter(grepl("Fewer Hours", design)) %>%
  alt_boxplot(var = "error_pct") %>%
  mutate_if(is.numeric, ~round(.)) %>%
  kable(caption = "Distribution of Coefficient errors (%) for fewer hours") %>%
  kable_styling()

```


# Appendix
## Inclusion/exclusion table

```{r}
# https://cran.r-project.org/web/packages/PRISMAstatement/vignettes/exclusionflowcharts.html 

# --> last row looks weird

print("persons")

flow_exclusions(
  incl_counts = exclusion_table$persons,
  total_label = "Full Cohort",
  incl_labels = exclusion_table$description[2:length(exclusion_table$description)],
  percent_of_total = T,
  format_args = list(big.mark  = ","))

```



