---
title: "Campaign Predictions Summary"
author: "Magali Blanco"
date: ' `r Sys.time()` '
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
    number_sections: true
    toc_float: true
    collapsed: false
    smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

# Setup 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      cache=F, cache.comments = F, 
                      message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE,
                      fig.height = 10, fig.width = 10
                      )  

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
           detach, character.only=TRUE, unload=TRUE, force=TRUE))
}

pacman::p_load(tidyverse, #kableExtra, 
               PRISMAstatement,table1
               #ggpmisc #add line fit parameters to ggplot()
               )    

set.seed(1)

source("functions.R")
output_data_path <- file.path("Output", "epi")

```

```{r}
##################################################################################################
# LOAD DATA
##################################################################################################
main_pollutants <-c("no2", "ns_total_conc")

campaign_descriptions <- readRDS("Output/Selected Campaigns/selected_campaigns.rda") %>%
  filter(variable %in% main_pollutants) %>%
  mutate(model_id = paste0("mb_", campaign_id)) %>%
  select(-campaign_id) %>%
  label_pollutants() %>% label_designs()

main_pollutants_labels <- unique(campaign_descriptions$variable)

cs <- readRDS(file.path(output_data_path, "dt_for_cross_sectional_analysis.rda")) %>%
  rename(model_id = model,
         exposure = avg_0_5_yr) %>%
  right_join(select(campaign_descriptions, model_id, variable, design, version, campaign), by="model_id") 

model_coefs <- readRDS(file.path(output_data_path, "model_coefs.rda")) %>% 
  filter(model_id %in% campaign_descriptions$model_id) %>%
  label_pollutants() %>% label_designs()

keep_vars <- readRDS(file.path("Output", "keep_vars.rda"))

exclusion_table <- read.csv(file.path(output_data_path, "exclusion_table.csv"))

#for boxplots
bp_min <- 0.025
bp_max <- 0.975

```

# Study Dates 

```{r}
range(cs$visitdt)

```

# QC variables

these QC variable values from the exposure (issue 17) & health (issue 12) dataset should be identical or very similar, and they are. 

```{r}
# names(cs)
qc_vars <- c("exp_coverage", "avg_wc_no2_MM_05_yr",
           "exact_coverage", "avg_ec_no2_MM_05_yr",
           "imp_coverage", "avg_ic_no2_MM_05_yr", 
           "imputation_quality", "avg_iq_no2_MM_05_yr")

cs %>%
  # person-level dataset
  select(study_id, all_of(qc_vars)) %>%
  distinct() %>%
  pivot_longer(cols = -study_id, names_to = "var", values_to = "value") %>%
  mutate(var=factor(var, levels=qc_vars)) %>%
  group_by(var) %>%
  summarize(
    N = n(),
    Min = min(value),
    Q25 = quantile(value, 0.25),
    Median = median(value),
    Mean = mean(value),
    Q75 = quantile(value, 0.75),
    Max = max(value)
  )

```


# Exposure

## predictions vs design

N_predictions = 65400 participant predictions = 30 campaigns * 2128 participants/campaign

```{r}
t1 <- cs %>%
  group_by(variable, design, version) %>%
  alt_boxplot(var = "exposure")  #%>% label_pollutants() %>% label_designs() 

t1

t1 %>%
  mutate(variable = gsub(" \\(", "\\\n(", unique(variable))) %>%
  ggplot(aes(x=version)) + 
   geom_boxplot(aes(ymin = Qmin, lower = Q25, middle = Q50, upper = Q75, ymax = Qmax),
   stat = "identity") + 
  facet_grid(variable~design, scales = "free") + 
  labs(y = "Predicted Exposure")

```


## Exposure  Model Performance

30 campaigns per design-version-pollutant 

```{r}
t2 <- campaign_descriptions %>%
  group_by(variable, design, version) %>%
  alt_boxplot(var = "MSE_based_R2", min_q=bp_min, max_q=bp_max) 
 
t2

t2 %>%
  ggplot(aes(x=version)) + 
   geom_boxplot(aes(ymin = Qmin, lower = Q25, middle = Q50, upper = Q75, ymax = Qmax),
   stat = "identity") + 
  facet_grid(variable~design, scales = "free") + 
  labs(y = "MSE-Based R2")

```


## Compare Design Predictions

```{r}
full <- filter(cs, grepl("All Data", design)) %>%
  select(study_id, variable, exposure, model_id) %>%
  rename(full_prediction = exposure)

designs <- filter(cs, !model_id %in% full$model_id) %>%
  select(study_id, variable, exposure, model_id, design, version, campaign) %>%
  rename(design_prediction = exposure)

comp <- left_join(select(full, -model_id), designs)

```

scatter plots/best fit lines: design prediction vs full prediction

```{r}
#pacman::p_load(ggpointdensity)
# library(ggpmisc)

# x = main_pollutants_labels[2]
lapply(main_pollutants_labels, function(x){
  p <- comp %>%
    filter(variable==x) %>%
    ggplot(aes(x=full_prediction, y=design_prediction, col=campaign
               )) + 
    facet_wrap_equal(~design+version) + 
    geom_abline(intercept=0, slope = 1, linetype=2, alpha=0.5, size=0.2) +
    #geom_pointdensity() +
    #geom_point(alpha=0.05) + 
    stat_smooth(geom="line", method="lm", aes(group=campaign), alpha=0.3, size=0.5) +
    #geom_smooth(method = "lm", aes(group=campaign), se=F, alpha=0.2, size=0.2) +
    stat_smooth(geom="line", method="lm", size=2) +
    #stat_poly_line() +
  # stat_poly_eq(aes(label = paste(after_stat(eq.label),
  #                                after_stat(rr.label), sep = "*\", \"*"))) +
     
    labs(x = "All Data Prediction", y = "Design Prediction",
         title = x
         )
  
  print(p)
  
})

```

distribution of correlations between full campaign and sampling design predictions (N= 30 correlations for each design-version)

```{r}
corr_table <- comp %>%
  group_by(variable, design, version, campaign) %>%
  summarize(n=n(),
            r = cor(full_prediction, design_prediction)) %>%
  group_by(variable, design, version) %>%
  alt_boxplot(var = "r", min_q=bp_min, max_q=bp_max) 

corr_table

corr_table %>%
    ggplot(aes(x=version, )) + 
  geom_boxplot(aes(ymin = Qmin, lower = Q25, middle = Q50, upper = Q75, ymax = Qmax), stat = "identity") + 
  facet_grid(variable~design, scales = "free") + 
  labs(y = "Pearson Correlation (R)")
  
 


```

# Table 1

```{r}
# Table1 tutorials: 
## https://cran.r-project.org/web/packages/table1/table1.pdf 
## https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html

# person-level dataset
pop <- cs %>%
  filter(design== "All Data") %>% 
  group_by(variable) %>%
  mutate(high_exposure = exposure > median(exposure),
         visit_age = visit_age_centered75+75
         ) %>%
  distinct(study_id, casi_irt, visit_age, year2, apoe, male, degree, race_white, variable, exposure, high_exposure) %>%
  pivot_wider(names_from = variable, values_from = c(high_exposure, exposure))  

names(pop) <- gsub("\\ .*|\\,.*", "", names(pop))
 
# table labels
t1_labels <- list(
  labels = list(
    casi_irt = "CASI-IRT",
    visit_age = "Visit Age",
    year2 = "Calendar Year (2 yr Cat)",
    apoe = "APOE e4 Allele",
    male = "Sex",
    degree = "Degree",
    race_white = "Race",
    variable = "Pollutant",
    #apoe_available = "Included in Main Analysis",
    #model_wt = "IPW for Modeling Cohort",
    high_exposure_PNC = "High PNC Exposure  (>Median)",
    high_exposure_NO2 = "NO2 Above Median",
    exposure_NO2 = "Residential NO2 (ppb) Exposure",
    exposure_PNC = "Residential PNC (pt/cm3) Exposure"
    ),
  units = list(
    visit_age = "Years"
     ),
  categoricals = list(
    apoe = list('1' = "Carriers",
                '0' = "Non-Carriers"),
    # apoe_available = list('TRUE' = "Included in Main Analysis",
    #                       'FALSE' = "Not Included in Main Analysis"),
    male = list('1' = "Male",
                '0' = "Female"),
     
        degree = list('0' = "None",
                  '1' = "GED/High School",
                  '3' = "Bachelor's",
                  '4' = "Master's",
                  '5' = "Doctorate",
                  '6' = "Other"),
    race_white = list('1' = "White",
                      '0' = "People of Color"),

    # income_cat = list('1' = "<$35,000",
    #                   '2' = "$35,000 - <$50,000",
    #                   '3' = "$50,000 - <$75,000",
    #                   '4' = ">$75,000"),
    
    high_exposure_PNC = list('FALSE' = "PNC Below Median",
                                   'TRUE' = "PNC Above Median"),
    high_exposure_NO2 = list('FALSE' = "No",
                                   'TRUE' = "Yes")
    ) 
  ) 

print("Baseline cohort characteristics stratified by whether 5-year median PNC concentration at baseline was below or above the median.")
# Main Table 1
t1read(filter(pop), t1_labels) %>%
  table1(~ visit_age + male + year2 + casi_irt + apoe + degree + race_white + exposure_PNC + exposure_NO2 + high_exposure_NO2 | high_exposure_PNC, data=.)

```



# Air Pollution & Baseline CASI-IRT Health Model Results

distribution of betas across designs (n=30 campaign models for each design-version)

```{r}
prop_sign <- model_coefs %>%
  group_by(variable, design, version) %>%
  summarize(prop_sign_neg = mean(lower<0 & upper<0),
            prop_sign_pos = mean(lower>0 & upper>0),
            prop_sign = mean(significant)
            )

coef_table <- model_coefs %>%
  group_by(variable, design, version) %>%
  alt_boxplot(var = "est") %>%
  left_join(prop_sign)

coef_table

coef_table %>%
  ggplot(aes(x=version)) + 
   geom_boxplot(aes(ymin = Qmin, lower = Q25, middle = Q50, upper = Q75, ymax = Qmax),
   stat = "identity") + 
  facet_grid(variable~design, scales = "free") + 
  labs(y = "Coefficient Estimate")



```

# --> modify models? 

```{r}
# x = main_pollutants_labels[2]
true_betas <- model_coefs %>%
  filter(design == "All Data") %>%
  select(variable, est, lower, upper)

print("beta estiamtes from the all data campaign")
true_betas

lapply(main_pollutants_labels, function(x){ 
    #p <- 
      model_coefs %>%
      filter(variable == x) %>%
    
      ggplot(aes(x=campaign, col=significant)) +  #col=version
      facet_wrap(~design+version) + 
      geom_hline(yintercept = 0, linetype=1, col="red") +
      geom_rect(inherit.aes = F, data=filter(true_betas, variable==x), aes(ymin = lower, ymax = upper, xmin=-Inf, xmax=Inf), alpha=0.3) +
      geom_hline(data=filter(true_betas, variable==x), aes(yintercept = est), linetype=1) +
      geom_pointrange(aes(y=est, ymin=lower, ymax=upper), size=0.5, alpha=0.8) +
      labs(title=x, col = "Statistically\nSignificant") 

  #print(p)
  
})


```

### --> repeat above as scatterplots, colored by significantly positive/negative/neighter?

```{r}

```




distribution of the SEs across designs

```{r}


```

```{r}

```



# Appendix
## Inclusion/exclusion table

-->example

```{r}
# https://cran.r-project.org/web/packages/PRISMAstatement/vignettes/exclusionflowcharts.html 

# --> last row looks weird

# persons
flow_exclusions(
  incl_counts = exclusion_table$persons,
  total_label = "Full Cohort",
  incl_labels = exclusion_table$description[2:length(exclusion_table$description)],
  percent_of_total = T,
  format_args = list(big.mark  = ",")
  )

# person-years
flow_exclusions(
  incl_counts = exclusion_table$person_years,
  total_label = "Full Cohort",
  incl_labels = exclusion_table$description[2:length(exclusion_table$description)],
  percent_of_total = T,
  format_args = list(big.mark  = ",")
  )

```




