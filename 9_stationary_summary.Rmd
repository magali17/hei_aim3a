---
title: "Epi results using stationary data exposure models"
author: "Magali Blanco"
date: ' `r Sys.time()` '
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
    number_sections: true
    toc_float: true
    collapsed: false
    smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

# Setup 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      cache=F, cache.comments = F, 
                      message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE#, fig.height = 10, fig.width = 10
                      )  

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
           detach, character.only=TRUE, unload=TRUE, force=TRUE))}

pacman::p_load(tidyverse, 
               PRISMAstatement,table1,
               knitr, kableExtra,
               ggpubr, #ggarrange()
               ggmap, sf, #mapping
               ggspatial, #mapping, adding scales, N arrows...
               spData, # us_states data - mapping WA state
               cowplot #layering ggplots. ggdraw(), draw_plot()
               )    

dt_path <- file.path("Output", readRDS(file.path("Output", "latest_dt_version.rda")))

set.seed(1)

source("functions.R")
output_data_path <- file.path(dt_path, "epi")

image_path <- file.path("..", "Manuscript", "Images", "v4") # "v3_20230321")

if(!dir.exists(file.path(image_path, "other", "presentation"))) {dir.create(file.path(image_path, "other", "presentation"), recursive = T)}
if(!dir.exists(file.path(image_path, "other", "poster"))) {dir.create(file.path(image_path, "other", "poster"), recursive = T)}
if(!dir.exists(file.path(image_path, "SI"))) {dir.create(file.path(image_path, "SI"), recursive = T)}

# ggplot settings
theme_set(theme_bw())
theme_update(legend.position = "bottom")

##################################################################################################
# LOAD DATA
##################################################################################################
#subset_site_type <- "22|18|12"
version_examples <- c("4", "12",  #visits/site
                      "1", #"3", #1 & 4 seasons
                      "Bus", "Rush", "Bus Adj", "Rush Adj",
                      "H22 L2", "H2 L22" #visit type
                      )
drop_site_types <- "H 8|H 4|H 10|H 14|H 16|H 20|L 8|L 4|L 10|L 14|l 16|L 20"
  
campaign_descriptions <- readRDS(file.path( dt_path, "Selected Campaigns", "selected_campaigns_v2.rda")) %>%
  #only show a few of these?
  filter(!grepl(drop_site_types, version)) %>%
  label_pollutants() %>% label_designs()  %>%
  mutate(
    ref = ifelse((design == "Fewer Visits" & version == "12") |
                   (design == "Fewer Seasons" & version == "4") |
                   (design == "Site Type" & version == "H12 L12"), "Design Reference", "More Restrictive or Less Balanced")) 

all_pollutants <- readRDS(file.path(output_data_path, "main_pollutants.rda"))
all_pollutants_labels <- unique(campaign_descriptions$variable)
main_pollutants_labels <- all_pollutants_labels[str_detect(all_pollutants_labels, "Total")]
sensitivity_pollutant_labels <- all_pollutants_labels[str_detect(all_pollutants_labels, "Total|10-100|100|20-1,000")]

cs <- readRDS(file.path(output_data_path, "dt_for_cross_sectional_analysis.rda")) %>%
  rename(exposure = avg_0_5_yr) %>%
  right_join(select(campaign_descriptions, model, variable, design, version, campaign), by="model")  
  
model_coefs0 <- readRDS(file.path(output_data_path, "model_coefs.rda"))

model_coefs <- model_coefs0 %>% 
  filter(model %in% campaign_descriptions$model) %>%
  label_pollutants() %>% label_designs() %>%
   mutate(
    ref = ifelse((design == "Fewer Visits" & version == "12") |
                   (design == "Fewer Seasons" & version == "4") |
                   (design == "Site Type" & version == "H12 L12"), "Design Reference", "More Restrictive or Less Balanced")) 

exclusion_table <- read.csv(file.path(output_data_path, "exclusion_table.csv"))

#issue 12 reference models
model_coefs_issue12 <- readRDS(file.path(output_data_path, "model_coefs_issue12.rda"))

##################################################################################################
#annual average site estimates (for exposure description)
annual_site_type <- readRDS(file.path(dt_path, "annual_site_type.rda")) %>%
  select(-no2) %>%
  # ? only visualize a few?
  filter(!grepl(drop_site_types, version)) 
  
annual_fixed_seasons <- readRDS(file.path(dt_path, "fixed_season_annual.rda"))  %>%
  select(-no2)
## fewer hrs w/ temp adj but only for total NS (drops P-TRAK used in sensitivity)
annual_temp_adj <- readRDS(file.path(dt_path, "temporal_adjustment.rda")) %>%
  mutate(visits=12)
##fewr hour designs not for total NS
annual_trainint_set0 <- readRDS(file.path(dt_path, "annual_training_set.rda")) 
annual_non_temp_adj <- annual_trainint_set0 %>%
  filter(design %in% c("fewer hours")) %>% 
  select(location, ns_10_100, pnc_noscreen, visits, campaign, design, version, spatial_temporal)
## combine
fewr_hrs <- left_join(annual_temp_adj, annual_non_temp_adj)

# combine everything
annual_trainint_set <- annual_trainint_set0 %>%
  filter(design %in% c("full", "fewer total stops")) %>%
  select(-no2, -spatial_temporal) %>%
  bind_rows(annual_site_type) %>%
  bind_rows(annual_fixed_seasons) %>% 
  bind_rows(fewr_hrs)


##################################################################################################
# COMMON VARIABLES

#for boxplots
bp_min <- 0.025
print(paste("Qmin in tables is", bp_min))
bp_max <- 0.975
print(paste("Qmax in tables is", bp_max))

one_to_one_band <- 0.2

#reference estimates
# --> OK that ref says "more restrictive or less bal"?
# ref_model_coefs <- model_coefs %>%
#   filter(design=="All Data")
# ggsave(ref_model_coefs, file.path())

# UW colors
uw_purple <- "#4b2e83"
uw_gold1 <- "#b7a57a" # web: e8e3d3
uw_gold2 <- "#85754d"

```

# Study Dates 


```{r}
range(cs$visitdt)

```

# QC variables

these QC variable values from the exposure (issue 17) & health (issue 12) dataset should be identical or very similar, and they are. 

```{r}
# names(cs)
qc_vars <- c("exp_coverage", "avg_wc_ufp_10_42_MM_05_yr",
           "exact_coverage", "avg_ec_ufp_10_42_MM_05_yr",
           "imp_coverage", "avg_ic_ufp_10_42_MM_05_yr", 
           "imputation_quality", "avg_iq_ufp_10_42_MM_05_yr")

cs %>%
  # person-level dataset
  select(study_id, all_of(qc_vars)) %>%
  distinct() %>%
  pivot_longer(cols = -study_id, names_to = "var", values_to = "value") %>%
  mutate(var=factor(var, levels=qc_vars)) %>%
  group_by(var) %>% 
  # 1 person has 4 QC variables missing
  drop_na(value) %>%
  summarize(
    N = n(),
    Min = min(value),
    Q25 = quantile(value, 0.25),
    Median = median(value),
    Mean = mean(value),
    Q75 = quantile(value, 0.75),
    Max = max(value)
  ) %>%
  kable(caption = "QC variables", digits = 2) %>%
  kable_styling()

# highest IQ value
distinct(cs, study_id, avg_iq_ufp_10_42_MM_05_yr) %>%
  drop_na(avg_iq_ufp_10_42_MM_05_yr) %>%
  summarize(
    n = n(),
    iq0 = sum(avg_iq_ufp_10_42_MM_05_yr==0)/n,
    iq1 = sum(avg_iq_ufp_10_42_MM_05_yr==1)/n,
    iq2 = sum(avg_iq_ufp_10_42_MM_05_yr==2)/n,
  )%>%
  kable(caption = "proportion of participants with varying imputation qualities", digits = 3) %>%
  kable_styling()

```



# Exposure

## Site annual averages


```{r}
annual_avgs <- annual_trainint_set %>%
  pivot_longer(cols = starts_with(c("pnc_", "ns_")), names_to = "variable", values_to = "value") %>%
  #temp adj is only for NS total
  drop_na(value) %>%
  filter(variable %in% all_pollutants) %>%
  label_pollutants(label = "ufp_range") %>%
  label_designs() %>%
  mutate(primary = ifelse(grepl("10-420", variable), "Primary", "Sensitivity"))

annual_avgs %>%
  group_by(design, version, variable) %>%
  summarize(
    n = n(),
    Min = min(value),
    Q25 = quantile(value, 0.25),
    Median = median(value),
    Mean = mean(value),
    Q75 = quantile(value, 0.75),
    Max = max(value)
  ) %>%
  kable(format.args = list(big.mark = ","), digits = 0) %>%
  kable_styling()

print("distribution of annual average site estimates used to develop exposure models")
annual_avgs %>%
  ggplot(aes(x=version, y=value, col=interaction(instrument, variable, sep = " "))) + 
  #facet_grid(~design, scales="free_x", space="free") + 
  facet_wrap(~design, scales="free_x", switch = "x", ncol = 2)+
  geom_boxplot(alpha=0.4,) +
  labs(y = "PNC (pt/cm3)", x="Version", col="Measure", fill="Analysis")

ggsave(file.path(image_path, "SI", "site_averages.png"), width = 8, height = 8)

```


## Model R2

### --> why do model R2 tell diff story than betas? are exposure model reference values a different distribtuion than the cohort? e.g., are more ppl living near/away form locations where exposure predictions improve/worsen? i.e., what are the places that do particularly bad/good with temporal adjustment? 
#### --> are things improving most where most of the cohort resides? 
#### --> do ppl do weighted avgs when calculationg model R2? weighted by amount of ppl near a location (i.e., how representative is a location relative to the cohort of interest?)

30 campaigns per design-version-pollutant 

```{r}
t2 <- campaign_descriptions %>%
  filter(variable %in% main_pollutants_labels) %>%
  group_by(variable, design, version) %>%
  alt_boxplot(var = "MSE_based_R2", min_q=bp_min, max_q=bp_max) %>%
  ungroup()

t2 %>%
  kable(caption = "Distribution of MSE-based R2 for each design", 
        digits = 2) %>%
  kable_styling()

print("dashed line is the All Data design performance")

refs1 <-campaign_descriptions %>%
  filter(design=="All Data", 
         grepl("All", design),
         variable %in% sensitivity_pollutant_labels) %>%
  select(variable, MSE_based_R2) %>%
  mutate(variable = ifelse(grepl("Total", variable), "10-420 nm (Primary)", as.character(variable)),
         variable = factor(variable, levels = c("10-420 nm (Primary)", "10-100 nm", "20-1,000 nm")))

# main analyses
campaign_descriptions %>%
  filter(variable %in% main_pollutants_labels,
         design != "All Data") %>%
    mutate(variable = ifelse(grepl("Total", variable), "10-420 nm (Primary)", as.character(variable)),
           variable = factor(variable, levels = c("10-420 nm (Primary)", "10-100 nm", "20-1,000 nm")),
           analysis = ifelse(grepl("10-420", variable), "Primary", "Sensitivity")) %>%

  ggplot(aes(x=version, y=MSE_based_R2)) + 
  geom_hline(data=filter(refs1, grepl("10-420", variable)), aes(yintercept = MSE_based_R2), linetype=2, alpha=0.5, ) + 
  geom_boxplot(aes(fill=ref))+
  facet_wrap(~design, scales = "free_x", #switch = "both"
             ) + 
  labs(y = "Exposure Model R2", x = "Design", fill=NULL)

ggsave(file.path(image_path, "r2.png"), width = 8, height = 6)

## sensitivity analyses
                      
campaign_descriptions %>%
  filter(variable %in% sensitivity_pollutant_labels,
         design != "All Data") %>%
    mutate(variable = ifelse(grepl("Total", variable), "10-420 nm (Primary)", as.character(variable)),
           variable = factor(variable, levels = c("10-420 nm (Primary)", "10-100 nm", "20-1,000 nm")),
           analysis = ifelse(grepl("10-420", variable), "Primary", "Sensitivity")) %>%

  ggplot(aes(x=version, y=MSE_based_R2)) + 
  geom_hline(data=refs1, aes(yintercept = MSE_based_R2), linetype=2, alpha=0.5, ) + 
  geom_boxplot(aes(fill=ref))+
  facet_grid(variable~design, scales = "free_x", switch = "both") + 
  labs(y = "Exposure Model R2", x = "Design", fill=NULL)

ggsave(file.path(image_path, "SI", "r2_sensitivity.png"), width = 10, height = 10)

```

### temporally adjusted designs

scatterplot of paired unadjusted & temporally adjusted campaigns

```{r}

print(paste0("dotted lines are +-", one_to_one_band*100, "%"))

campaign_descriptions %>%
  filter(design == "Fewer Hours",
         variable == main_pollutants_labels) %>%
  select(-c(model, RMSE)) %>% 
  mutate(adjusted = ifelse(grepl("Adj", version, ignore.case=T), "Adjusted", "Unadjusted"),
         version = gsub(" Adj", "", version)) %>% 
  pivot_wider(names_from = adjusted, values_from = MSE_based_R2) %>%
  mutate(performance = ifelse(Adjusted > Unadjusted, "Improved", "Not Improved")) %>%
  
  ggplot(aes(x=Unadjusted, y=Adjusted, #shape=version
             )) + 
  facet_wrap(~version) +
  geom_abline(slope = c(1), intercept = 0, linetype=2, alpha=0.5) +
  geom_abline(slope = c(1-one_to_one_band, 1+one_to_one_band), intercept = 0, linetype=3, alpha=0.25) +
  geom_smooth(method = "lm") +
  geom_point(aes(col=performance)) +
  #make x y equal size
  theme(aspect.ratio = 1) +
  geom_label(x=Inf, y=Inf, label="1-1", vjust=1, hjust=1, show.legend = F, col="black") +
  labs(shape="Fewer Hours Design", 
       col = "Impact of Temporal Adjustment on Model R2",
       x = "Unadjusted Campaign R2",
       y = "Temporally Adjusted Campaign R2")
  
ggsave(file.path(image_path, "SI", "r2_temp_adj.png"), width = 6, height = 4)

```



### poster

```{r, eval=F}
# this was for an older version that didn't include e.g. site type or temporal adj
campaign_descriptions %>%
  filter(variable %in% main_pollutants_labels,) %>%
  ggplot(aes(x=version, y=MSE_based_R2)) + 
  geom_hline(data=select(filter(t2, design=="All Data"), variable, Q50), aes(yintercept = Q50), linetype=2, alpha=0.5) + 
  geom_boxplot(fill=uw_gold1, col=uw_purple)+
  facet_grid(~design, scales = "free", switch = "both") +
  labs(y = "Exposure Model R2", x = "Design")

ggsave(file.path(image_path, "other", "poster", "exposure r2.png"), width = 4.5, height = 2.5)

```

## Participant Exposures

N_predictions = 65400 participant predictions = 30 campaigns * 2128 participants/campaign

```{r}
t1 <- cs %>%
  filter(variable %in% main_pollutants_labels) %>%
  group_by(variable, design, version) %>%
  #alt_boxplot(var = "exposure")  
  summarize(
      N = n(),
      Min = min(exposure),
      Q2.5 = quantile(exposure, 0.025),
      Q25 = quantile(exposure, 0.25),
      Q50 = quantile(exposure, 0.50),
      Q75 = quantile(exposure, 0.75),
      Q97.5 = quantile(exposure, 0.975),
      Max = max(exposure),
      IQR = Q75-Q25,
      range = Max-Min
    )

t1 %>%
  kable(caption = "Predicted exposures by design", 
        digits = 0, #format.args = list(big.mark  = ",")
        ) %>%
  kable_styling()

```

```{r}
# alt to above: scatterplots
ref <- cs %>%
  filter(grepl("All Data", design),
         variable %in% sensitivity_pollutant_labels) %>%
  select(study_id, all_exposure = exposure, all_model = model, variable)

samples <- cs %>%
  filter(!grepl("All Data", design),
         variable %in% sensitivity_pollutant_labels,
         #only show some examples
         version %in% version_examples
         ) %>%
  select(study_id, exposure,  model, variable, design, version, campaign)

comp_exp <- left_join(ref, samples)
# x=sensitivity_pollutant_labels[2]
lapply(sensitivity_pollutant_labels, function(x) {
  
  p <- comp_exp %>%
  filter(variable== x) %>%
    ggplot(aes(x=all_exposure, y=exposure, col=campaign, group=campaign)) +
    facet_wrap_equal(~design+version, ncol=4) + 
    geom_smooth(se = F, size=0.25, alpha=0.4) + 
    geom_smooth(se = F, inherit.aes = F, aes(x=all_exposure, y=exposure), col="black") + 
    geom_abline(slope = 1, intercept = 0, linetype=2, alpha=0.5) +
    geom_abline(slope = 1.25, intercept = 0, linetype=3, alpha=0.3) + 
    geom_abline(slope = 0.75, intercept = 0, linetype=3, alpha=0.3) + 
    #make x y equal size  
    theme(aspect.ratio = 1) +
    
    labs(x = "All Data Exposure Prediction", 
         y= "Sampling Design Exposure Prediction", 
         title = x,
         col="Campaign")

  if(grepl("Total|10-420", x)) {
    print(p)
    ggsave(file.path(image_path, "SI", paste0("predicted_exposure_",x ,".png")), width = 7, height = 7)
    } else{
      #p <- p + labs(title = x)
      print(p)
      ggsave(file.path(image_path, "SI", paste0("predicted_exposure_",x ,".png")), width = 7, height = 5)
    }

})


```

comparison of exposures from the issue 12 model to the all-data HEI model

```{r}
bound0 <- 0.1
print(paste0("NanoScan reference models. dashed line is 1-1 and +-", bound0*100, "%"))
cs %>%
  filter(model == "s_nstot_all_01") %>%
  ggplot(aes(x=exposure, y=cum_exp_ufp_10_42_MM_05_yr)) + 
  geom_point(alpha=0.1) + 
  geom_smooth() +
  geom_abline(slope = 1, intercept = 0, linetype=2, alpha=0.5) +
  geom_abline(slope = c(1+bound0, 1-bound0), intercept = 0, linetype=3, alpha=0.3) + 
  #make x y equal size  
  theme(aspect.ratio = 1) +
  labs(x="s_nstot_all_01", 
       caption = paste0("dashed line is 1-1 and +-", bound0*100, "%"))

ggsave(file.path(image_path, "other", "qc", "all_data_ns_vs_issue12_model.png"), width = 6, height = 6)

print(paste0("P-TRAK reference models. dashed line is 1-1 and +-", bound0*100, "%"))
cs %>%
  filter(model == "s_pncnoscreen_all_01") %>%
  ggplot(aes(x=exposure, y=cum_exp_ufp_20_1k_MM_05_yr)) + 
  geom_point(alpha=0.1) + 
  geom_smooth() +
  geom_abline(slope = 1, intercept = 0, linetype=2, alpha=0.5) +
  geom_abline(slope = c(1+bound0, 1-bound0), intercept = 0, linetype=3, alpha=0.3) + 
  #make x y equal size  
  theme(aspect.ratio = 1) +
  labs(x="s_pncnoscreen_all_01",
       caption = paste0("dashed line is 1-1 and +-", bound0*100, "%"))
ggsave(file.path(image_path, "other", "qc", "all_data_ns_ptrak_issue12_model.png"), width = 6, height = 6)

```





## Prediction Correlations

```{r}
full <- cs %>% 
  filter(grepl("All Data", design),
         variable %in% sensitivity_pollutant_labels) %>%
  select(study_id, variable, exposure, model) %>%
  rename(full_prediction = exposure)

designs <- filter(cs, 
                  variable %in% sensitivity_pollutant_labels,
                  !model %in% full$model) %>%
  select(study_id, variable, exposure, model, design, version, campaign) %>%
  rename(design_prediction = exposure)

comp <- left_join(select(full, -model), designs)

```

correlations (N= 30 correlations for each design-version)

```{r}
corr_table <- comp %>%
  group_by(model, variable, design, version, campaign) %>%
  summarize(n=n(),
            r = cor(full_prediction, design_prediction))  %>%
  ungroup() %>%
  mutate(
    ref = ifelse((design == "Fewer Visits" & version == "12") |
                   (design == "Fewer Seasons" & version == "4") |
                   (design == "Site Type" & version == "H12 L12"), "Design Reference", "More Restrictive or Less Balanced")) 

corr_table %>%
  group_by(variable, design, version) %>%
  alt_boxplot(var = "r", min_q=bp_min, max_q=bp_max) %>%
  
  kable(caption = "Distribution of Pearson correlations (R) between full campaign and sampling design predictions (N= 30 correlations for each design-version)", 
        digits = 2) %>%
  kable_styling()

corr_table %>%
  filter(variable %in% main_pollutants_labels) %>% 
  ggplot(aes(x=version, y=r, fill=ref)) +
  geom_boxplot()+
  facet_grid(~design, scales = "free", switch="both") + 
  facet_wrap(~design, scales = "free", switch="x") + 
  labs(y = "Correlation (R)", x = "Design", fill=NULL)

ggsave(file.path(image_path, "prediction_correlations.png"), width = 8, height = 6)

#SI
corr_table %>%
  mutate(variable = ifelse(grepl("Total", variable), "10-420 nm (Primary)", as.character(variable)),
           variable = factor(variable, levels = c("10-420 nm (Primary)", "10-100 nm", "20-1,000 nm")),
           analysis = ifelse(grepl("10-420", variable), "Primary", "Sensitivity")) %>%

  ggplot(aes(x=version, y=r, fill=ref)) +
  geom_boxplot(aes())+
  facet_grid(variable~design, scales = "free_x", switch="both") + 
  labs(y = "Correlation (R)", x = "Design", col="Analysis", fill=NULL)

ggsave(file.path(image_path, "SI", "prediction_correlations2.png"), width = 12, height = 10)

```

### poster

```{r, eval=F}
corr_table %>%
  ggplot(aes(x=version, y=r )) +
  geom_boxplot(fill=uw_gold1, col=uw_purple)+
  facet_grid(~design, scales = "free", switch="both") + 
  labs(y = "Correlation (R)",
       x = "Design")

ggsave(file.path(image_path, "other", "poster", "prediction_correlations.png"), width = 12, height = 3)
```


# CASI


```{r}
# person-level dataset
pop <- cs %>%
  filter(variable %in% main_pollutants_labels,
         design== "All Data") %>% 
  group_by(variable) %>%
  mutate(high_exposure = exposure > median(exposure),
         visit_age = visit_age_centered75+75
         ) %>%
  distinct(study_id, casi_irt, visit_age, year2, #apoe, 
           male, degree, 
           #race_white, 
           variable, exposure, high_exposure) %>%
  pivot_wider(names_from = variable, values_from = c(high_exposure, exposure))  

names(pop) <- gsub("\\ .*|\\,.*", "", names(pop))

pop %>%
  alt_boxplot(var="casi_irt") %>%
  kable(caption = "Distribution of CASI-IRT", 
        digits = 2) %>%
  kable_styling()

```


# Table 1

## --> update table if update model covariates

```{r}
# Table1 tutorials: 
## https://cran.r-project.org/web/packages/table1/table1.pdf 
## https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html
 
# table labels
t1_labels <- list(
  labels = list(
    casi_irt = "CASI-IRT",
    visit_age = "Visit Age",
    year2 = "Calendar Year (2 yr Cat)",
    apoe = "APOE e4 Allele",
    male = "Sex",
    degree = "Degree",
    #race_white = "Race",
    variable = "Pollutant",
    #apoe_available = "Included in Main Analysis",
    #model_wt = "IPW for Modeling Cohort",
    high_exposure_PNC = "High PNC Exposure  (>Median)",
    #high_exposure_NO2 = "NO2 Above Median",
    #exposure_NO2 = "Residential NO2 (ppb) Exposure",
    exposure_PNC = "Residential PNC (pt/cm3) Exposure"
    ),
  units = list(
    visit_age = "Years"
     ),
  categoricals = list(
    apoe = list('1' = "Carriers",
                '0' = "Non-Carriers"),
    # apoe_available = list('TRUE' = "Included in Main Analysis",
    #                       'FALSE' = "Not Included in Main Analysis"),
    male = list('1' = "Male",
                '0' = "Female"),
     
        degree = list('0' = "None",
                  '1' = "GED/High School",
                  '3' = "Bachelor's",
                  '4' = "Master's",
                  '5' = "Doctorate",
                  '6' = "Other"),
    # race_white = list('1' = "White",
    #                   '0' = "People of Color"),

    # income_cat = list('1' = "<$35,000",
    #                   '2' = "$35,000 - <$50,000",
    #                   '3' = "$50,000 - <$75,000",
    #                   '4' = ">$75,000"),
    
    high_exposure_PNC = list('FALSE' = "PNC Below Median",
                                   'TRUE' = "PNC Above Median")
    # high_exposure_NO2 = list('FALSE' = "No",
    #                                'TRUE' = "Yes")
    ) 
  ) 

print("Baseline cohort characteristics stratified by whether 5-year PNC exposure at baseline was below or above the median.")
# Main Table 1
t1read(filter(pop), t1_labels) %>%
  table1(~ visit_age + male + 
           #year2 + #note: ~38% of the sample had their first visit in 1994-1995 
            #apoe + 
           degree + casi_irt, #+ exposure_PNC, #  | high_exposure_PNC, 
         data=.)

```

# Health Model Results

```{r}
rectangle_alpha <- 0.15

```


## Beta Estimates 

as a reference, these are the health effect estimates from issue 12. The models are developed slightly different (e.g., have 3 vs 2 PLS components; ~1 extra modeling covariate is available; all available visit data are used in the models rather than conditioning on availability of NS readings)

```{r}
model_coefs_issue12 %>%
  kable(caption = "issue 12 health effect estimates for NS and P-TRAK models", digits=3) %>%
  kable_styling()
```

### paper

The black horizontal line and gray area are the health effect estimate from the full campaign

```{r, fig.height=8, fig.width=8}
# x = main_pollutants_labels[2]
true_betas <- model_coefs %>%
  filter(design == "All Data",
         variable %in% sensitivity_pollutant_labels
         ) %>%
  select(variable, est, lower, upper, se) %>%
   mutate(variable2 = variable,
          variable = ifelse(grepl("Total", variable), "10-420 nm", as.character(variable)),
           variable = factor(variable, levels = c("10-420 nm", "10-100 nm", "20-1,000 nm")),
           analysis = ifelse(grepl("10-420", variable), "Primary", "Sensitivity")) 

true_betas %>%
  select(-variable2) %>%
  mutate_if(is.numeric, ~round(., 3)) %>%
  kable(caption = "coefficient health estiamtes from the all data campaign") %>%
  kable_styling()

p_list <- unique(true_betas$variable) %>% as.character()
# x = p_list[2]
lapply(p_list, function(x){ 
    
      p <- model_coefs %>%
        mutate(variable = ifelse(grepl("Total", variable), "10-420 nm", as.character(variable)),
           variable = factor(variable, levels = c("10-420 nm", "10-100 nm", "20-1,000 nm")),
           analysis = ifelse(grepl("10-420", variable), "Primary", "Sensitivity"),
           adjusted = ifelse(grepl("Adj", version, ignore.case=T), "Temporally Adjusted", "Unadjusted"),
           adjusted = factor(adjusted, levels = c("Unadjusted", "Temporally Adjusted")),
           version = gsub(" Adj", "", version),
           significant = ifelse(significant==TRUE, "Stat. Sign.", "Not Stat. Sign.")
           ) %>%
        filter(variable == x,
             design != "All Data",
             version %in% version_examples) %>%
        
        ggplot(aes(x=campaign, col=significant, shape=adjusted)) +
        geom_hline(yintercept = 0, linetype=2, alpha=0.2) +
      geom_rect(inherit.aes = F, data=filter(true_betas, variable==x), aes(ymin = lower, ymax = upper, xmin=-Inf, xmax=Inf), alpha=rectangle_alpha) +
      geom_hline(data=filter(true_betas, variable==x), aes(yintercept = est)) +
      geom_pointrange(aes(y=est, ymin=lower, ymax=upper), size=0.4, 
                      position=position_dodge(width=0.7)) +
      scale_x_continuous(breaks = c(1, seq(10,30,10))) +
      labs(x="Campaign", y = "Coefficient Estimate (95% CI)", shape=NULL, col=NULL)
      
      if(grepl("10-420 nm|Total", x)) {
        p <- p + facet_wrap(~design+version, ncol = 2)
        print(p)
        ggsave(file.path(image_path, paste0("beta_", x, ".png")), width = 12, height = 8)
        } else {
        p <- p + facet_wrap(~design+version, ncol = 2) +
          labs(title=x)
        print(p)
        ggsave(file.path(image_path, "SI", paste0("beta_", x, ".png")), width = 12, height = 8)}
      })

```


tables include the proportion significant

```{r}
prop_sign <- model_coefs %>%
  group_by(variable, design, version) %>%
  summarize(prop_sign = mean(significant),
            sd = sd(est))

coef_table <- model_coefs %>%
  group_by(variable, design, version) %>%
  alt_boxplot(var = "est") %>%
  left_join(prop_sign)

coef_table %>%
  filter(variable %in% main_pollutants_labels) %>%
  kable(caption = "Distribution of health effect estimates from each design, and the proportion of campaigns that produce significant findings", 
        digits = 3) %>%
  kable_styling()


#######################################
prop_sign %>%
  filter(variable %in% main_pollutants_labels,
         grepl("Visits|Seasons", design)
         ) %>%
  group_by(variable) %>%
  alt_boxplot(var = "prop_sign") %>%
  mutate_if(is.numeric, ~round(., 2)) %>%
  kable(caption = "Distribution of proportion of significant findings for fewer visits & seasons") %>%
  kable_styling()

#######################################
```



```{r, eval=F}
# x = p_list[2] #total UFP
# print(x)
# #add fewer hour unadj & adjusted side by side
#         b <- model_coefs %>%
#           filter(design == "Fewer Hours",
#                  variable == main_pollutants_labels) %>%
#           select(-c(model, RMSE)) %>% 
#           mutate(adjusted = ifelse(grepl("Adj", version, ignore.case=T), "Temporally Adjusted", "Unadjusted"),
#                  adjusted = factor(adjusted, levels = c("Unadjusted", "Temporally Adjusted")),
#                  version = gsub(" Adj", "", version)) %>%   
#         
#           ggplot(aes(x=campaign, shape=adjusted, col=significant)) +
#           facet_wrap(~design+version, ncol = 2) + 
#           geom_hline(yintercept = 0, linetype=2, alpha=0.2) +
#           geom_rect(inherit.aes = F, data=filter(true_betas, variable==x), aes(ymin = lower, ymax = upper, xmin=-Inf, xmax=Inf), alpha=rectangle_alpha) +
#           geom_hline(data=filter(true_betas, variable==x), aes(yintercept = est)) +
#           geom_pointrange(aes(y=est, ymin=lower, ymax=upper), size=0.5, #alpha=0.8,
#                           position=position_dodge(width=0.6)) +
#           scale_x_continuous(#breaks = c(1, seq(10,30,10))
#             breaks=NULL
#                              ) +
#           labs(x= NULL,#"Campaign", 
#                y = "Coefficient Estimate", 
#                col = "Statistically Significant", shape=NULL)
#         
#         ggarrange(b, p , ncol = 1, heights = c(1,2.5), align = "v", 
#                   common.legend = T, legend = "bottom")  
# ggsave(file.path(image_path, "SI", paste0("beta_", x, "_temp_adj.png")), width = 7, height = 6)

```

```{r}
d <- c("All", "Visits", "Seasons", "Hours")

```

### for ppt
same as above for presentation

```{r, eva=F}

p <- lapply(d, function(x) {
  p <- model_coefs %>%
      filter(grepl("Total", variable),
             grepl(x, design)) %>%
    
      ggplot(aes(x=campaign, col=significant)) +  
      facet_grid(design~version, scales="free_x", switch = "both") + 
      geom_hline(yintercept = 0, linetype=2, alpha=0.2) +
      geom_rect(inherit.aes = F, data=filter(true_betas, grepl("Total", variable)), 
                aes(ymin = lower, ymax = upper, xmin=-Inf, xmax=Inf), alpha=0.25) +
      geom_hline(data=filter(true_betas, grepl("Total", variable)), 
                 aes(yintercept = est)) +
      geom_pointrange(aes(y=est, ymin=lower, ymax=upper), size=0.5, alpha=0.8) +
      labs(col = "Statistically Significant", x="Campaign", y = "Coefficient Estimate (95% CI)")
  
  print(p)

  ggsave(file.path(image_path, "other", "presentation", paste0("beta ", x, ".png")), width = 6, height = 4)

})

```

### poster


```{r, eva=F}
#--> update

model_coefs %>%
    filter(grepl("Total", variable),
           (design %in% c("Fewer Hours", "All Data") |
              (design == "Fewer Visits" & version=="12")
              )
           ) %>%
  mutate(significant = ifelse(significant==TRUE, "Stat. Sign.", "Not Stat. Sign."),
         significant = factor(significant, levels = c("Stat. Sign.", "Not Stat. Sign."))
         ) %>%
  
    ggplot(aes(x=campaign, col=significant)) +  
    facet_wrap(~design+version, scales="free_x",  #switch = "x"
               ) + 
    #facet_grid(design~version, scales="free", switch = "both", ) + 
    geom_hline(yintercept = 0, linetype=2, alpha=0.3) +
    geom_rect(inherit.aes = F, data=filter(true_betas, grepl("Primary", analysis)), 
              aes(ymin = lower, ymax = upper, xmin=-Inf, xmax=Inf), alpha=0.25) +
    geom_hline(data=filter(true_betas, grepl("Primary", analysis)), 
               aes(yintercept = est)) +
    geom_pointrange(aes(y=est, ymin=lower, ymax=upper), size=0.15, 
                    #alpha=0.8
                    ) +
  theme(axis.text.x = element_blank(),
       axis.ticks.x=element_blank()) +
  
  scale_color_manual(values = c(uw_purple, uw_gold1)) +
  
    labs(col = "", #"Statistically Significant",
         x="Campaign (1-30)",
         y = "Health Effect Estimate")
  

ggsave(file.path(image_path, "other", "poster", paste0("betas.png")), width = 6, height = 5.5)
  
```

## Beta Summary

```{r}
y_lims <- c(-0.018, 0.0005)

model_coefs %>%
  filter(grepl("Visits|Seasons", design)) %>%
  group_by(variable) %>%
  alt_boxplot(var = "est") %>%
  kable(caption = "distribution of Coefficient estimates for fewer visits & seasons", digits = 3) %>%
  kable_styling()

# keep this even though code below is the same to not show facet label for main analysis figure
# true Coefficient estimate
tot_pnc <- filter(true_betas, grepl("Total|10-420", variable)) %>%
  pull(est)

model_coefs %>%
  filter(grepl("Total", variable)) %>%  
  
  ggplot(aes(x=version, y=est, fill=ref)) +
  #ggforce::facet_row(facets = vars(design), scales = "free_x", space  = "free") +
  facet_wrap(~design, scales="free_x", #switch="x"
             ) +
  geom_hline(yintercept = tot_pnc, linetype=1, alpha=0.5) +
  geom_hline(yintercept = 0, linetype=2, alpha=0.2) +
  geom_boxplot() +
  scale_y_continuous(sec.axis = sec_axis(trans=~(.-tot_pnc)/-tot_pnc, name="% Difference", labels = scales::percent), #limits = y_lims
                     ) +
    geom_label(inherit.aes = F, data=mutate(filter(true_betas, grepl("Total|10-420", variable)), design="All Data" ) %>% mutate(design= factor(design, levels= levels(model_coefs$design))), aes(x=1, y=est, label = round(tot_pnc, 2))) +
  labs(y = "Coefficient Point Estimate", x = "Design",
       fill= NULL
       )

ggsave(file.path(image_path, "beta_boxplots_main.png"), width = 10, height = 6)

# SI

lapply(c("10-420 nm", "10-100 nm", "20-1,000 nm"), function(x) {
  
  # for second axis
  ref_pnc <- true_betas$est[true_betas$variable==x]
  
  true_betas2 <- true_betas %>% 
    mutate(variable = ifelse(variable == "10-420 nm", "10-420 nm (Primary)", as.character(variable)))
 
  
  p <- model_coefs %>%
    
    mutate(variable = ifelse(grepl("Total", variable), "10-420 nm (Primary)", as.character(variable)),
           variable = factor(variable, levels = c("10-420 nm (Primary)", "10-100 nm", "20-1,000 nm")))  %>%
    filter(grepl(x, variable)) %>%
  
    ggplot(aes(x=version, y=est, fill=ref)) +
    facet_grid(variable~design, scales="free", switch="both", space="free") + 
    geom_hline(yintercept = ref_pnc, linetype=1, alpha=0.5) +
    geom_hline(yintercept = 0, linetype=2, alpha=0.2) +
    geom_boxplot() + 
    scale_y_continuous(sec.axis = sec_axis(trans=~(.-ref_pnc)/-ref_pnc, name="% Difference", labels = scales::percent)#, #limits = c(-0.02, 0.001)
                       ) +
    geom_label(inherit.aes = F, data=filter(true_betas2, grepl(x, variable)) %>% 
                 mutate(design="All Data", 
                        design= factor(design, levels= levels(model_coefs$design))
                        ),
               aes(x=1, y=est, label = round(est, 2))) +
  labs(y = "Coefficient Point Estimate", x = "Design", fill=NULL)
  
  p
  }) %>%
  ggarrange(plotlist = ., ncol = 1, common.legend = T, legend = "bottom")

ggsave(file.path(image_path, "SI", "beta_boxplots.png"), width = 10, height = 10)


```


### for ppt

```{r, eval=F}

model_coefs %>%
  filter(grepl("Total|10-420", variable)) %>%
  
  ggplot(aes(x=version, y=est)) +
  facet_grid(~design, scales="free", switch="both", space="free") + 
  geom_hline(data=filter(true_betas, grepl("Total", variable)),
             aes(yintercept = est), linetype=1, alpha=0.5) +
  geom_hline(yintercept = 0, linetype=2, alpha=0.2) +
  geom_boxplot(fill=uw_gold1, col=uw_purple)+
  scale_y_continuous(sec.axis = sec_axis(
    trans=~(.-tot_pnc)/-tot_pnc, name="% Difference", labels = scales::percent)) +
  geom_label(data=mutate(filter(true_betas, grepl("Total|10-420", variable)), design="All Data" ) %>% mutate(design= factor(design, levels= levels(model_coefs$design))), 
                         aes(x=1, y=est, label = round(tot_pnc, 3)), col=uw_purple) +
  labs(y = "Health Effect Estimate", x = "Design" )


#ggsave(file.path(image_path, "other", "presentation", "beta_summary.png"), width = 6, height = 4)

```

### for poster
```{r, eval=F}
ggsave(file.path(image_path, "other", "poster", "beta_summary.png"), width = 5, height = 2.5)
```



```{r}
bias0 <- model_coefs %>%
  group_by(variable) %>%
  mutate(ref = est[design == "All Data"],
         error = est - ref,
         error_pct = round(error/abs(ref)*100, 1)) %>%
  filter(design != "All Data",
         variable %in% main_pollutants_labels) 


bias <- bias0 %>%
  group_by(variable, design, version) %>%
  alt_boxplot(var = "error") 

bias %>% 
  kable(caption = "Distribution of coefficient difference for each design", 
        digits = 3) %>%
  kable_styling()

#######################################
bias0 %>%
  filter(grepl("Visits|Seasons", design)) %>%
  alt_boxplot(var = "error") %>%
  mutate_if(is.numeric, ~round(., 3)) %>% 
  kable(caption = "Distribution of Coefficient errors for fewer visits & seasons") %>%
  kable_styling()

bias0 %>%
  filter(grepl("Fewer Hours", design)) %>%
  alt_boxplot(var = "error") %>%
  mutate_if(is.numeric, ~round(.,3)) %>%
  kable(caption = "Distribution of Coefficient differences for fewer hours") %>%
  kable_styling()

```


Percent error in the estimated betas (n=30 campaign models for each design-version)

```{r}

bias_pct <- bias0 %>%
  group_by(variable, design, version) %>%
  alt_boxplot(var = "error_pct") 

bias_pct %>% 
  #select(-c(Qmin, Qmax)) %>%
  mutate_if(is.numeric, ~round(.)) %>%
  kable(caption = "Distribution of Coefficient difference (%) for each design") %>%
  kable_styling()


#######################################
bias0 %>%
  filter(grepl("Visits|Seasons", design)) %>%
  alt_boxplot(var = "error_pct") %>%
  mutate_if(is.numeric, ~round(.)) %>%
  kable(caption = "Distribution of Coefficient difference (%) for fewer visits & seasons") %>%
  kable_styling()

bias0 %>%
  filter(grepl("Fewer Hours", design)) %>%
  alt_boxplot(var = "error_pct") %>%
  mutate_if(is.numeric, ~round(.)) %>%
  kable(caption = "Distribution of Coefficient errors (%) for fewer hours") %>%
  kable_styling()

```


# Appendix
## Inclusion/exclusion table

```{r}
# https://cran.r-project.org/web/packages/PRISMAstatement/vignettes/exclusionflowcharts.html 

# --> last row looks weird

print("persons")

flow_exclusions(
  incl_counts = exclusion_table$persons,
  total_label = "Full Cohort",
  incl_labels = exclusion_table$description[2:length(exclusion_table$description)],
  percent_of_total = T,
  format_args = list(big.mark  = ","))

```



