---
title: "Epi Results using Machine Learning UFP Exposure Models"
author: "Magali Blanco"
date: ' `r Sys.time()` '
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
    number_sections: true
    toc_float: true
    collapsed: false
    smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

# Setup 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      cache=F, cache.comments = F, 
                      message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE#, fig.height = 10, fig.width = 10
                      )  

# Clear workspace of all objects and unload all extra (non-base) packages
rm(list = ls(all = TRUE))
if (!is.null(sessionInfo()$otherPkgs)) {
  res <- suppressWarnings(
    lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
           detach, character.only=TRUE, unload=TRUE, force=TRUE))}

pacman::p_load(tidyverse, #knitr, 
               kableExtra
               )    

dt_path <- file.path("Output", readRDS(file.path("Output", "latest_dt_version.rda")))

set.seed(1)

source("functions.R")
output_data_path <- file.path(dt_path, "epi")

image_path <- file.path("..", "Manuscript", "Images", "v3_20230321")

# if(!dir.exists(file.path(image_path, "other", "presentation"))) {dir.create(file.path(image_path, "other", "presentation"), recursive = T)}
# if(!dir.exists(file.path(image_path, "other", "poster"))) {dir.create(file.path(image_path, "other", "poster"), recursive = T)}
# if(!dir.exists(file.path(image_path, "SI"))) {dir.create(file.path(image_path, "SI"), recursive = T)}

# ggplot settings
theme_set(theme_bw())
theme_update(legend.position = "bottom")


```

```{r}
##################################################################################################
# LOAD DATA
##################################################################################################

# --> fix char/factor merging issue???
cw_ml <- read.csv(file.path(dt_path, "model_ml_cw2.csv")) %>%
  label_pollutants() #%>% label_designs()  

cs_ml <- readRDS(file.path(output_data_path, "dt_for_cross_sectional_analysis_machine_learning.rda")) %>%
  rename(exposure = avg_0_5_yr) %>% #left_join(cw_ml)  
  select(-starts_with("avg_"))
  
model_coefs0_ml <- readRDS(file.path(output_data_path, "model_coefs_ml.rda"))

model_coefs_ml <- model_coefs0_ml #%>% 
  
  # --> doesnt do anything 
  #label_pollutants() %>% label_designs()

```

# Model definitions

Si used stop readings from the unscreened P-TRAK

```{r}
cw_ml %>%
  kable() %>% 
  kable_styling()

```


# Model R2

### --> what are the model R2/performance statistics? are all of these in Si's 2023 paper along w/ model descriptions? 

```{r}

```

# Exposure correlations

all models generate highly correlated predictions

```{r}

cs_ml %>%
  pivot_wider(names_from = model, values_from = exposure) %>%
  pivot_longer(cols = urf:utr) %>%
  group_by(name) %>%
  summarize(correlation = cor(upls, value)) %>%
  kable(caption = "Correlation (R) of UK-PLS predictions with predictions from machine learning methods", 
        digits = 2,
        col.names = c("ML Exposure Model", "Correlation with UK-PLS")
          ) %>%
  kable_styling()

```

# Compare participant exposures 

comparison of predicted 5 yr exposures at baseline

```{r}

cs_ml %>%
  pivot_wider(names_from = model, values_from = exposure) %>%  
  pivot_longer(cols = urf:utr) %>%
  
  ggplot(aes(x=upls, y=value, col=name)) +
  geom_point(alpha=0.05) +
  geom_smooth() +
  geom_abline(slope = 1, intercept = 0, linetype=2) + 
  labs(col="Machine Learning\nModel", y="Machine Learning Prediction", x= "UK-PLS Prediction")

```



# Comparison of health effect estimates (CASI-IRT)

the resulting health estimates from using UK-PLS and various ML UFP exposure models is similar, with random forests & spatcv being the most different (~25-35% lower point estimate)

```{r}
ref_beta <- model_coefs0_ml$est[model_coefs0_ml$model=="upls"]

model_coefs_ml %>%
  ggplot(aes(x=model, col=significant)) +  
  geom_hline(yintercept = ref_beta, linetype=1, alpha=0.5) +
  geom_hline(yintercept = 0, linetype=2, alpha=0.2) +
  geom_pointrange(aes(y=est, ymin=lower, ymax=upper), size=0.5, alpha=0.8) +
  
  scale_y_continuous(sec.axis = sec_axis(
    trans=~(.-ref_beta)/-ref_beta, name="% Difference from UK-PLS", labels = scales::percent)) +
  labs(col = "Statistically Significant",
           x="Machine Learning Model",
           y = "Beta Estimate (per 1k pt/cm3)"
           )

```



